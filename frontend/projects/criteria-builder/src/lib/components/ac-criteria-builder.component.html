<div class="ac-criteria-builder" 
     [class.disabled]="disabled"
     [class.loading]="isLoading"
     [class.compact]="config.compactMode">
  
  <!-- Loading State -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner">
      <i class="pi pi-spin pi-spinner"></i>
      <span>Loading criteria builder...</span>
    </div>
  </div>
  
  <!-- API Error Banner -->
  <div class="api-error-banner" *ngIf="hasApiError">
    <i class="pi pi-exclamation-triangle"></i>
    <span>{{ apiErrorMessage }}. Using fallback data.</span>
  </div>
  
  <!-- Builder Toolbar -->
  <ac-builder-toolbar
    [currentDSL]="currentDSL$ | async"
    [mode]="mode$ | async"
    [config]="config"
    (modeChange)="setMode($event)"
    (clearAll)="clearAll()"
    (addCondition)="addCondition()">
  </ac-builder-toolbar>
  
  <!-- Error Banner for Validation -->
  <ac-error-banner
    [validationResult]="validationResult$ | async"
    [showDetails]="getCurrentMode() === 'advanced'">
  </ac-error-banner>
  
  <!-- Main Query Display Area -->
  <div class="query-display-area">
    <ac-token-query-display
      [dsl]="currentDSL$ | async"
      [tokens]="tokenizedQuery$ | async"
      [fields]="fields$ | async"
      [functions]="functions$ | async"
      [operators]="operators$ | async"
      [config]="config"
      [mode]="mode$ | async"
      [disabled]="disabled"
      (dslChange)="onDslChange($event)"
      (tokenSelect)="onTokenSelect($event)">
    </ac-token-query-display>
    
    <!-- Empty State Placeholder -->
    <div class="empty-state" 
         *ngIf="(tokenizedQuery$ | async)?.length === 0 && !isLoading">
      <div class="empty-state-content">
        <i class="pi pi-plus-circle"></i>
        <h3>No conditions defined</h3>
        <p>Click the button below to add your first condition</p>
        <button type="button" 
                class="add-first-condition-btn"
                [disabled]="disabled"
                (click)="addCondition()">
          <i class="pi pi-plus"></i>
          Add Condition
        </button>
      </div>
    </div>
  </div>
  
  <!-- SQL Preview Panel -->
  <ac-sql-preview
    *ngIf="config.showSqlPreview"
    [dsl]="currentDSL$ | async"
    [isValid]="isValid$ | async"
    [collapsed]="getCurrentMode() === 'simple'">
  </ac-sql-preview>
  
</div>