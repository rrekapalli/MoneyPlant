<div class="sql-preview-container" [class.collapsed]="collapsed" *ngIf="visible">
  <p-panel 
    header="SQL Preview" 
    [toggleable]="true" 
    [collapsed]="collapsed"
    styleClass="sql-preview-panel">
    
    <!-- Header actions -->
    <ng-template pTemplate="icons">
      <button 
        pButton 
        type="button" 
        icon="pi pi-refresh" 
        class="p-button-text p-button-sm"
        pTooltip="Refresh all previews"
        tooltipPosition="bottom"
        (click)="refresh()"
        [disabled]="!criteria || isLoading()">
      </button>
    </ng-template>

    <!-- Content -->
    <div class="sql-preview-content" [style.max-height]="mergedConfig.maxHeight">
      
      <!-- Empty state -->
      <div class="empty-state" *ngIf="!criteria">
        <i class="pi pi-info-circle"></i>
        <p>No criteria available for preview</p>
        <small>Build your criteria to see SQL generation and validation results</small>
      </div>

      <!-- Loading state -->
      <div class="loading-state" *ngIf="criteria && isLoading() && !hasContent()">
        <p-progressSpinner [style]="{ width: '50px', height: '50px' }"></p-progressSpinner>
        <p>Generating preview...</p>
      </div>

      <!-- Tab view with results -->
      <p-tabs 
        *ngIf="criteria && hasContent()" 
        [(value)]="activeTabIndex"
        styleClass="sql-preview-tabs">
        
        <p-tablist>
          <p-tab 
            *ngIf="mergedConfig.showSqlTab"
            value="0">
            <i class="pi pi-code"></i>
            SQL Query
          </p-tab>
          <p-tab 
            *ngIf="mergedConfig.showPreviewTab"
            value="1">
            <i class="pi pi-eye"></i>
            Preview
          </p-tab>
          <p-tab 
            *ngIf="mergedConfig.showValidationTab"
            value="2">
            <i class="pi pi-shield"></i>
            Validation
          </p-tab>
        </p-tablist>

        <p-tabpanels>
          <!-- SQL Tab -->
          <p-tabpanel 
            *ngIf="mergedConfig.showSqlTab"
            value="0">
          
          <div class="sql-tab-content">
            <!-- Loading indicator -->
            <div class="tab-loading" *ngIf="isLoadingSql$ | async">
              <p-progressSpinner [style]="{ width: '20px', height: '20px' }"></p-progressSpinner>
              <span>Generating SQL...</span>
            </div>

            <!-- Error state -->
            <p-message 
              *ngIf="sqlError$ | async as error"
              severity="error" 
              [text]="error"
              styleClass="sql-error-message">
            </p-message>

            <!-- SQL content -->
            <div class="sql-content" *ngIf="sqlResult$ | async as sqlResult">
              <div class="sql-header">
                <div class="sql-status">
                  <i 
                    class="pi" 
                    [class.pi-check-circle]="sqlResult.success"
                    [class.pi-times-circle]="!sqlResult.success"
                    [class.success-icon]="sqlResult.success"
                    [class.error-icon]="!sqlResult.success">
                  </i>
                  <span class="status-text">
                    {{ sqlResult.success ? 'SQL Generated Successfully' : 'SQL Generation Failed' }}
                  </span>
                </div>
                
                <div class="sql-actions" *ngIf="sqlResult.success && mergedConfig.enableCopyToClipboard">
                  <button 
                    pButton 
                    type="button" 
                    icon="pi pi-copy" 
                    class="p-button-text p-button-sm"
                    pTooltip="Copy SQL to clipboard"
                    tooltipPosition="bottom"
                    (click)="copySqlToClipboard()">
                  </button>
                </div>
              </div>

              <!-- SQL code block -->
              <div class="sql-code-container" *ngIf="sqlResult.success && sqlResult.sql">
                <pre 
                  #sqlCodeBlock
                  class="sql-code"
                  [class.syntax-highlighted]="mergedConfig.enableSyntaxHighlighting">{{ formatSql(sqlResult.sql) }}</pre>
              </div>

              <!-- SQL parameters -->
              <div class="sql-parameters" *ngIf="sqlResult.parameters && sqlResult.parameters.length > 0">
                <h4>Parameters</h4>
                <div class="parameter-list">
                  <div 
                    class="parameter-item" 
                    *ngFor="let param of sqlResult.parameters">
                    <span class="param-name">{{ param.name }}</span>
                    <span class="param-type">{{ param.type }}</span>
                    <span class="param-value">{{ param.value }}</span>
                    <i 
                      class="pi pi-asterisk param-required" 
                      *ngIf="param.required"
                      pTooltip="Required parameter">
                    </i>
                  </div>
                </div>
              </div>

              <!-- SQL warnings -->
              <div class="sql-warnings" *ngIf="sqlResult.warnings && sqlResult.warnings.length > 0">
                <h4>Warnings</h4>
                <p-message 
                  *ngFor="let warning of sqlResult.warnings"
                  severity="warn" 
                  [text]="warning">
                </p-message>
              </div>
            </div>
          </div>
          </p-tabpanel>

          <!-- Human-readable Preview Tab -->
          <p-tabpanel 
            *ngIf="mergedConfig.showPreviewTab"
            value="1">
          
          <div class="preview-tab-content">
            <!-- Loading indicator -->
            <div class="tab-loading" *ngIf="isLoadingPreview$ | async">
              <p-progressSpinner [style]="{ width: '20px', height: '20px' }"></p-progressSpinner>
              <span>Generating preview...</span>
            </div>

            <!-- Error state -->
            <p-message 
              *ngIf="previewError$ | async as error"
              severity="error" 
              [text]="error"
              styleClass="preview-error-message">
            </p-message>

            <!-- Preview content -->
            <div class="preview-content" *ngIf="previewResult$ | async as previewResult">
              <div class="preview-header">
                <div class="preview-status">
                  <i 
                    class="pi" 
                    [class.pi-check-circle]="previewResult.success"
                    [class.pi-times-circle]="!previewResult.success"
                    [class.success-icon]="previewResult.success"
                    [class.error-icon]="!previewResult.success">
                  </i>
                  <span class="status-text">
                    {{ previewResult.success ? 'Preview Generated' : 'Preview Generation Failed' }}
                  </span>
                </div>
                
                <div class="preview-actions" *ngIf="previewResult.success && mergedConfig.enableCopyToClipboard">
                  <button 
                    pButton 
                    type="button" 
                    icon="pi pi-copy" 
                    class="p-button-text p-button-sm"
                    pTooltip="Copy preview to clipboard"
                    tooltipPosition="bottom"
                    (click)="copyPreviewToClipboard()">
                  </button>
                </div>
              </div>

              <!-- Description -->
              <div class="preview-description" *ngIf="previewResult.success && previewResult.description">
                <h4>Description</h4>
                <p>{{ previewResult.description }}</p>
              </div>

              <!-- Structured preview -->
              <div class="preview-sections" *ngIf="previewResult.success && previewResult.preview && previewResult.preview.length > 0">
                <h4>Structure</h4>
                <div class="section-list">
                  <div 
                    class="section-item" 
                    *ngFor="let section of previewResult.preview"
                    [class]="'level-' + section.level"
                    [class.section-group]="section.type === 'group'"
                    [class.section-condition]="section.type === 'condition'"
                    [class.section-function]="section.type === 'function'">
                    
                    <div class="section-header">
                      <i 
                        class="pi section-icon"
                        [class.pi-folder]="section.type === 'group'"
                        [class.pi-filter]="section.type === 'condition'"
                        [class.pi-cog]="section.type === 'function'">
                      </i>
                      <span class="section-title">{{ section.title }}</span>
                    </div>
                    
                    <div class="section-content" *ngIf="section.content">
                      {{ section.content }}
                    </div>

                    <!-- Nested sections -->
                    <div class="nested-sections" *ngIf="section.children && section.children.length > 0">
                      <div 
                        class="nested-section" 
                        *ngFor="let child of section.children"
                        [class]="'level-' + child.level">
                        <span class="nested-title">{{ child.title }}</span>
                        <span class="nested-content">{{ child.content }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </p-tabpanel>

          <!-- Validation Tab -->
          <p-tabpanel 
            *ngIf="mergedConfig.showValidationTab"
            value="2">
          
          <div class="validation-tab-content">
            <!-- Loading indicator -->
            <div class="tab-loading" *ngIf="isLoadingValidation$ | async">
              <p-progressSpinner [style]="{ width: '20px', height: '20px' }"></p-progressSpinner>
              <span>Validating criteria...</span>
            </div>

            <!-- Error state -->
            <p-message 
              *ngIf="validationError$ | async as error"
              severity="error" 
              [text]="error"
              styleClass="validation-error-message">
            </p-message>

            <!-- Validation content -->
            <div class="validation-content" *ngIf="validationResult$ | async as validationResult">
              <div class="validation-header">
                <div class="validation-status">
                  <i 
                    class="pi" 
                    [class.pi-check-circle]="validationResult.isValid"
                    [class.pi-times-circle]="!validationResult.isValid"
                    [class.success-icon]="validationResult.isValid"
                    [class.error-icon]="!validationResult.isValid">
                  </i>
                  <span class="status-text">{{ getValidationSummary(validationResult) }}</span>
                </div>
                
                <div class="validation-timestamp">
                  <small>Last validated: {{ validationResult.timestamp | date:'short' }}</small>
                </div>
              </div>

              <!-- Validation errors -->
              <div class="validation-errors" *ngIf="validationResult.errors && validationResult.errors.length > 0">
                <h4>Errors</h4>
                <div class="error-list">
                  <div 
                    class="error-item" 
                    *ngFor="let error of validationResult.errors"
                    [class]="getSeverityClass(error.severity)">
                    
                    <div class="error-header">
                      <i [class]="getSeverityIcon(error.severity)"></i>
                      <span class="error-code">{{ error.code }}</span>
                      <span class="error-path" *ngIf="error.path">{{ error.path }}</span>
                    </div>
                    
                    <div class="error-message">{{ error.message }}</div>
                    
                    <div class="error-suggestion" *ngIf="error.suggestion">
                      <i class="pi pi-lightbulb"></i>
                      <span>{{ error.suggestion }}</span>
                    </div>
                    
                    <div class="error-actions" *ngIf="error.canAutoFix">
                      <button 
                        pButton 
                        type="button" 
                        label="Auto Fix" 
                        icon="pi pi-wrench"
                        class="p-button-sm p-button-outlined"
                        pTooltip="Automatically fix this error">
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Validation warnings -->
              <div class="validation-warnings" *ngIf="validationResult.warnings && validationResult.warnings.length > 0">
                <h4>Warnings</h4>
                <div class="warning-list">
                  <div 
                    class="warning-item" 
                    *ngFor="let warning of validationResult.warnings">
                    
                    <div class="warning-header">
                      <i class="pi pi-exclamation-triangle"></i>
                      <span class="warning-code">{{ warning.code }}</span>
                      <span class="warning-path" *ngIf="warning.path">{{ warning.path }}</span>
                    </div>
                    
                    <div class="warning-message">{{ warning.message }}</div>
                    
                    <div class="warning-suggestion" *ngIf="warning.suggestion">
                      <i class="pi pi-lightbulb"></i>
                      <span>{{ warning.suggestion }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Success state -->
              <div class="validation-success" *ngIf="validationResult.isValid && validationResult.errors.length === 0 && validationResult.warnings.length === 0">
                <div class="success-message">
                  <i class="pi pi-check-circle success-icon"></i>
                  <span>Your criteria is valid and ready to use!</span>
                </div>
              </div>
            </div>
          </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </div>
  </p-panel>
</div>