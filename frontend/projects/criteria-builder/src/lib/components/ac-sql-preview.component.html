<div class="ac-sql-preview" [class.collapsed]="collapsed">
  
  <!-- Preview Header with Toggle -->
  <div class="preview-header" (click)="toggleCollapsed()">
    <div class="header-content">
      <h4 class="preview-title">
        <i class="pi pi-code"></i>
        SQL Preview
      </h4>
      
      <!-- Status Indicators -->
      <div class="status-indicators">
        <span class="loading-indicator" *ngIf="isGenerating">
          <i class="pi pi-spin pi-spinner"></i>
          Generating...
        </span>
        
        <span class="error-indicator" *ngIf="hasError">
          <i class="pi pi-exclamation-triangle"></i>
          Error
        </span>
        
        <span class="success-indicator" *ngIf="!isGenerating && !hasError && (sqlResult$ | async)">
          <i class="pi pi-check-circle"></i>
          Ready
        </span>
      </div>
    </div>
    
    <div class="header-actions">
      <!-- Copy All Button (visible when not collapsed) -->
      <button type="button" 
              class="copy-all-btn"
              *ngIf="!collapsed && (sqlResult$ | async)"
              (click)="copyAllToClipboard(); $event.stopPropagation()"
              title="Copy SQL and Parameters">
        <i class="pi pi-copy"></i>
        Copy All
      </button>
      
      <!-- Collapse Toggle -->
      <i class="pi toggle-icon" 
         [class.pi-chevron-down]="collapsed" 
         [class.pi-chevron-up]="!collapsed">
      </i>
    </div>
  </div>
  
  <!-- Preview Content -->
  <div class="preview-content" *ngIf="!collapsed">
    
    <!-- Loading State -->
    <div class="loading-state" *ngIf="isGenerating">
      <div class="loading-content">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Generating SQL from criteria...</span>
      </div>
    </div>
    
    <!-- Error State -->
    <div class="error-state" *ngIf="hasError && !isGenerating">
      <div class="error-content">
        <i class="pi pi-exclamation-triangle"></i>
        <div class="error-details">
          <h5>SQL Generation Failed</h5>
          <p>{{ errorMessage }}</p>
        </div>
      </div>
    </div>
    
    <!-- Invalid Criteria State -->
    <div class="invalid-state" *ngIf="!canGenerateSql() && !isGenerating && !hasError">
      <div class="invalid-content">
        <i class="pi pi-info-circle"></i>
        <div class="invalid-details">
          <h5>No SQL Available</h5>
          <p *ngIf="!dsl || !dsl.root || dsl.root.children.length === 0">
            Add conditions to your criteria to generate SQL.
          </p>
          <p *ngIf="dsl && dsl.root && dsl.root.children.length > 0 && !isValid">
            Fix validation errors in your criteria to generate SQL.
          </p>
        </div>
      </div>
    </div>
    
    <!-- SQL Results -->
    <div class="sql-results" *ngIf="(sqlResult$ | async) as sqlResult">
      
      <!-- SQL Query Section -->
      <div class="sql-section">
        <div class="section-header">
          <label class="section-label">
            <i class="pi pi-code"></i>
            Generated SQL
          </label>
          <button type="button" 
                  class="copy-btn"
                  (click)="copySqlToClipboard()"
                  title="Copy SQL to clipboard">
            <i class="pi pi-copy"></i>
            Copy SQL
          </button>
        </div>
        
        <div class="code-container">
          <pre class="sql-code" [innerHTML]="sqlResult.sql"></pre>
        </div>
      </div>
      
      <!-- Parameters Section -->
      <div class="params-section" *ngIf="hasParameters()">
        <div class="section-header">
          <label class="section-label">
            <i class="pi pi-list"></i>
            Parameters
          </label>
          <button type="button" 
                  class="copy-btn"
                  (click)="copyParamsToClipboard()"
                  title="Copy parameters to clipboard">
            <i class="pi pi-copy"></i>
            Copy Params
          </button>
        </div>
        
        <div class="code-container">
          <pre class="params-code">{{ getFormattedParameters() }}</pre>
        </div>
      </div>
      
      <!-- Generation Metadata -->
      <div class="generation-info" *ngIf="getGenerationInfo()">
        <small class="info-text">
          <i class="pi pi-info-circle"></i>
          {{ getGenerationInfo() }}
        </small>
      </div>
      
    </div>
    
  </div>
  
</div>