<!-- MpCriteriaBuilderComponent Template -->
<div class="mp-criteria-builder" 
     [class.disabled]="isDisabledState"
     [class.readonly]="readonly">
  
  <!-- Main criteria builder area -->
  <div class="criteria-container">
    
    <!-- Mode selection -->
    <div class="mode-selection" *ngIf="!readonly">
      <label>
        <input type="radio" 
               name="mode" 
               value="field" 
               [checked]="!isFunctionMode"
               (change)="toggleFunctionMode()">
        Field Mode
      </label>
      <label>
        <input type="radio" 
               name="mode" 
               value="function" 
               [checked]="isFunctionMode"
               (change)="toggleFunctionMode()">
        Function Mode
      </label>
    </div>

    <!-- Field selection dropdown -->
    <div class="field-selection" *ngIf="hasFields && !readonly && !isFunctionMode">
      <label for="field-select">Select Field:</label>
      <select id="field-select"
              (change)="onFieldSelected($event.target.value)"
              [disabled]="isDisabledState">
        <option value="">Choose a field...</option>
        <option *ngFor="let field of fields"
                [value]="field.id">
          {{ field.label }} ({{ field.dataType }})
        </option>
      </select>
    </div>

    <!-- Function selection dropdown -->
    <div class="function-selection" *ngIf="hasFunctions && !readonly && isFunctionMode">
      <label for="function-select">Select Function:</label>
      <select id="function-select"
              (change)="onFunctionSelected($event.target.value)"
              [disabled]="isDisabledState">
        <option value="">Choose a function...</option>
        <option *ngFor="let function of functions"
                [value]="function.id">
          {{ function.name }} - {{ function.description }}
        </option>
      </select>
    </div>

    <!-- Operator selection dropdown -->
    <div class="operator-selection" *ngIf="hasFields && !readonly && selectedField">
      <label for="operator-select">Select Operator:</label>
      <select id="operator-select" 
              (change)="onOperatorSelected($event.target.value)"
              [disabled]="isDisabledState">
        <option value="">Choose an operator...</option>
        <option *ngFor="let operator of availableOperators" 
                [value]="operator">
          {{ getOperatorLabel(operator) }}
        </option>
      </select>
    </div>

    <!-- Value input -->
    <div class="value-input" *ngIf="hasFields && !readonly && selectedField && selectedOperator && !isFunctionMode">
      <label for="value-input">Enter Value:</label>
      <input id="value-input"
             [type]="getInputType(selectedField.dataType)"
             (input)="onValueChanged($event.target.value)"
             [disabled]="isDisabledState"
             [placeholder]="getInputPlaceholder(selectedField.dataType)">
    </div>

    <!-- Function parameter configuration -->
    <div class="function-parameters" *ngIf="hasFunctions && !readonly && selectedFunction && isFunctionMode">
      <h4>Configure Parameters:</h4>
      <div class="parameter-item" 
           *ngFor="let param of selectedFunction.parameters; let i = index; trackBy: trackByParameterName">
        
        <label class="parameter-label">
          {{ param.name }}
          <span class="parameter-type">({{ param.type }})</span>
          <span class="parameter-required" *ngIf="!param.optional">*</span>
        </label>
        
        <div class="parameter-input">
          
          <!-- Field reference input -->
          <select *ngIf="param.type === 'FIELD'"
                  [value]="getFunctionParameterValue(i)"
                  (change)="onFunctionParameterChanged(i, $event.target.value, 'field')"
                  [disabled]="isDisabledState">
            <option value="">Select field...</option>
            <option *ngFor="let field of fields" 
                    [value]="field.id">
              {{ field.label }}
            </option>
          </select>
          
          <!-- Literal value input -->
          <input *ngIf="param.type !== 'FIELD'"
                 [type]="getInputType(param.type)"
                 [value]="getFunctionParameterValue(i)"
                 (input)="onFunctionParameterChanged(i, $event.target.value, 'literal')"
                 [placeholder]="getParameterPlaceholder(param)"
                 [disabled]="isDisabledState">
          
          <!-- Parameter description -->
          <div class="parameter-help" *ngIf="param.description">
            <small>{{ param.description }}</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Criteria display area -->
    <div class="criteria-display">
      <div class="criteria-badges" *ngIf="state.dsl">
        <!-- Render root group with nested structure -->
        <mp-group-badge 
          [group]="state.dsl.root"
          [isNested]="false"
          [nestingLevel]="0"
          [disabled]="isDisabledState"
          [readonly]="readonly"
          (badgeAction)="onGroupBadgeAction($event)">
          
          <!-- Render children recursively -->
          <ng-container *ngFor="let child of state.dsl.root.children; trackBy: trackByElementId">
            <ng-container [ngSwitch]="getElementType(child)">
              
              <!-- Render condition -->
              <div *ngSwitchCase="'condition'" class="condition-container">
                <mp-field-badge 
                  [field]="getFieldFromCondition(child)"
                  [disabled]="isDisabledState"
                  [readonly]="readonly"
                  (badgeAction)="onBadgeAction($event)">
                </mp-field-badge>
                
                <mp-operator-badge 
                  [operator]="child.operator"
                  [disabled]="isDisabledState"
                  [readonly]="readonly"
                  (badgeAction)="onBadgeAction($event)">
                </mp-operator-badge>
                
                <mp-value-badge 
                  *ngIf="child.right"
                  [literal]="child.right"
                  [disabled]="isDisabledState"
                  [readonly]="readonly"
                  (badgeAction)="onBadgeAction($event)">
                </mp-value-badge>
              </div>
              
              <!-- Render nested group -->
              <mp-group-badge 
                *ngSwitchCase="'group'"
                [group]="child"
                [isNested]="true"
                [nestingLevel]="1"
                [disabled]="isDisabledState"
                [readonly]="readonly"
                (badgeAction)="onGroupBadgeAction($event)">
                
                <!-- Recursively render nested group children -->
                <ng-container *ngFor="let nestedChild of child.children; trackBy: trackByElementId">
                  <ng-container [ngSwitch]="getElementType(nestedChild)">
                    
                    <!-- Nested condition -->
                    <div *ngSwitchCase="'condition'" class="condition-container">
                      <mp-field-badge 
                        [field]="getFieldFromCondition(nestedChild)"
                        [disabled]="isDisabledState"
                        [readonly]="readonly"
                        (badgeAction)="onBadgeAction($event)">
                      </mp-field-badge>
                      
                      <mp-operator-badge 
                        [operator]="nestedChild.operator"
                        [disabled]="isDisabledState"
                        [readonly]="readonly"
                        (badgeAction)="onBadgeAction($event)">
                      </mp-operator-badge>
                      
                      <mp-value-badge 
                        *ngIf="nestedChild.right"
                        [literal]="nestedChild.right"
                        [disabled]="isDisabledState"
                        [readonly]="readonly"
                        (badgeAction)="onBadgeAction($event)">
                      </mp-value-badge>
                    </div>
                    
                    <!-- Deeper nested groups would be handled recursively -->
                    <!-- For now, limit to 2 levels for simplicity -->
                    
                  </ng-container>
                </ng-container>
              </mp-group-badge>
              
            </ng-container>
          </ng-container>
        </mp-group-badge>
      </div>
      
      <div class="empty-state" *ngIf="!state.dsl">
        <p>No criteria defined yet. Select a field, operator, and value to get started.</p>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="action-buttons" *ngIf="!readonly">
      <!-- Undo/Redo buttons -->
      <div class="undo-redo-buttons" *ngIf="config.enableUndo">
        <button type="button" 
                (click)="undo()"
                [disabled]="isDisabledState || !canUndo()"
                class="btn btn-outline-secondary"
                title="Undo (Ctrl+Z)">
          ↶ Undo
        </button>
        
        <button type="button" 
                (click)="redo()"
                [disabled]="isDisabledState || !canRedo()"
                class="btn btn-outline-secondary"
                title="Redo (Ctrl+Y)">
          ↷ Redo
        </button>
      </div>

      <button type="button" 
              (click)="addCondition()"
              [disabled]="isDisabledState || !selectedField || !selectedOperator || inputValue === null"
              class="btn btn-primary"
              *ngIf="!isFunctionMode">
        Add Condition
      </button>
      
      <button type="button" 
              (click)="addFunctionCall()"
              [disabled]="isDisabledState || !selectedFunction"
              class="btn btn-primary"
              *ngIf="isFunctionMode">
        Add Function Call
      </button>
      
      <button type="button" 
              (click)="addGroup('AND')"
              [disabled]="isDisabledState"
              class="btn btn-info">
        Add AND Group
      </button>
      
      <button type="button" 
              (click)="addGroup('OR')"
              [disabled]="isDisabledState"
              class="btn btn-warning">
        Add OR Group
      </button>
      
      <button type="button" 
              (click)="addGroup('NOT')"
              [disabled]="isDisabledState"
              class="btn btn-danger">
        Add NOT Group
      </button>
      
      <button type="button" 
              (click)="clearCriteria()"
              [disabled]="isDisabledState || !state.dsl"
              class="btn btn-secondary">
        Clear All
      </button>
    </div>

  </div>

  <!-- Validation status -->
  <div class="validation-status" *ngIf="validationResult">
    <div class="validation-errors" *ngIf="!validationResult.isValid">
      <h4>Validation Errors:</h4>
      <ul>
        <li *ngFor="let error of validationResult.errors">
          {{ error.message }}
        </li>
      </ul>
    </div>
    
    <div class="validation-warnings" *ngIf="validationResult.warnings.length > 0">
      <h4>Warnings:</h4>
      <ul>
        <li *ngFor="let warning of validationResult.warnings">
          {{ warning.message }}
        </li>
      </ul>
    </div>
  </div>

  <!-- SQL Preview -->
  <div class="sql-preview" *ngIf="config.showSqlPreview && sqlPreview">
    <h4>SQL Preview:</h4>
    <pre class="sql-code">{{ sqlPreview }}</pre>
  </div>

</div>
