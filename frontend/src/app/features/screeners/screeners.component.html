<div class="screeners-container">
  <!-- Header with Search and Create Button -->
  <div class="header">
    <div class="header-left">
      <h1>Stock Screeners</h1>
      <div class="search-container">
        <input 
          type="text" 
          pInputText 
          placeholder="Search screeners..." 
          [(ngModel)]="searchQuery"
          (keyup.enter)="onSearch()"
          class="search-input"
        />
        <button pButton icon="pi pi-search" (click)="onSearch()" class="p-button-outlined"></button>
      </div>
    </div>
    <button pButton label="Create Screener" icon="pi pi-plus" (click)="createScreener()" class="create-button"></button>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="error-message">
    <p-message severity="error" [text]="error"></p-message>
  </div>

  <!-- Loading State -->
  <p-card *ngIf="loading" styleClass="loading-card">
    <div class="loading-message">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      <p>Loading screeners...</p>
    </div>
  </p-card>

  <!-- Main Content -->
  <div *ngIf="!loading">
    <p-tabs [(value)]="activeTab" class="screener-tabs" (valueChange)="onTabChange($event)">
      <p-tablist>
        <p-tab value="0">
          <i class="pi pi-chart-line"></i>
          Overview
        </p-tab>
        <p-tab value="1">
          <i class="pi pi-cog"></i>
          Configure
        </p-tab>
      </p-tablist>
      <p-tabpanels>

        <!-- Overview Tab Panel -->
        <p-tabpanel value="0">
          <div class="overview-content">
            <!-- Filter and Search Section -->
            <div class="filter-section">
              <div class="search-container">
                <input 
                  type="text" 
                  pInputText 
                  placeholder="Search screeners..." 
                  [(ngModel)]="searchQuery"
                  (keyup.enter)="onSearch()"
                  class="search-input"
                />
                <button pButton icon="pi pi-search" (click)="onSearch()" class="p-button-outlined"></button>
              </div>
              <div class="filter-options">
                <p-select 
                  [options]="visibilityOptions" 
                  [(ngModel)]="selectedVisibility" 
                  placeholder="All Visibility"
                  (onChange)="onFilterChange()"
                  class="visibility-filter">
                </p-select>
                <p-select 
                  [options]="categoryOptions" 
                  [(ngModel)]="selectedCategory" 
                  placeholder="All Categories"
                  (onChange)="onFilterChange()"
                  class="category-filter">
                </p-select>
                <button pButton label="Clear Filters" icon="pi pi-times" (click)="clearFilters()" class="p-button-text"></button>
              </div>
            </div>

            <!-- Screeners List -->
            <div class="screeners-list">
              <div *ngIf="getFilteredScreeners().length === 0" class="empty-message">
                <i class="pi pi-search" style="font-size: 3rem; color: #ccc;"></i>
                <p>No screeners found.</p>
                <button pButton label="Create Your First Screener" (click)="createScreener()" class="p-button-outlined"></button>
              </div>
              
              <div *ngFor="let screener of getFilteredScreeners(); trackBy: trackScreenerById" class="screener-item">
                <div class="screener-header">
                  <div class="screener-info">
                    <h3 class="screener-name">{{ screener.name }}</h3>
                    <p class="screener-description">{{ screener.description || 'No description available' }}</p>
                    <div class="screener-meta">
                      <span class="meta-item">
                        <i class="pi pi-calendar"></i>
                        Created: {{ formatDate(screener.createdAt) }}
                      </span>
                      <span class="meta-item">
                        <i class="pi pi-clock"></i>
                        Updated: {{ formatDate(screener.updatedAt) }}
                      </span>
                      <span class="meta-item">
                        <i class="pi pi-users"></i>
                        {{ screener.isPublic ? 'Public' : 'Private' }}
                      </span>
                    </div>
                  </div>
                  <div class="screener-actions">
                    <button 
                      pButton 
                      icon="pi pi-star" 
                      [class]="isStarred(screener) ? 'p-button-rounded p-button-sm p-button-warning' : 'p-button-rounded p-button-sm p-button-outlined'"
                      (click)="toggleStar(screener)" 
                      [title]="isStarred(screener) ? 'Remove from starred' : 'Add to starred'"
                      class="star-button"
                    ></button>
                    <button 
                      pButton 
                      icon="pi pi-play" 
                      class="p-button-rounded p-button-sm p-button-success" 
                      (click)="runScreener(screener)" 
                      title="Run Screener"
                      pTooltip="Run Screener"
                    ></button>
                    <button 
                      pButton 
                      icon="pi pi-eye" 
                      class="p-button-rounded p-button-sm p-button-info" 
                      (click)="viewResults(screener)" 
                      title="View Results"
                      pTooltip="View Results"
                    ></button>
                    <button 
                      pButton 
                      icon="pi pi-pencil" 
                      class="p-button-rounded p-button-sm p-button-warning" 
                      (click)="configureScreener(screener)" 
                      title="Configure Screener"
                      pTooltip="Configure Screener"
                    ></button>
                    <button 
                      pButton 
                      icon="pi pi-trash" 
                      class="p-button-rounded p-button-sm p-button-danger" 
                      (click)="deleteScreener(screener)" 
                      title="Delete Screener"
                      pTooltip="Delete Screener"
                    ></button>
                  </div>
                </div>
                <div class="screener-details">
                  <div class="detail-item">
                    <span class="detail-label">Default Universe:</span>
                    <span class="detail-value">{{ screener.defaultUniverse || 'Not specified' }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Status:</span>
                    <p-tag 
                      value="Active" 
                      severity="success"
                    ></p-tag>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </p-tabpanel>

        <!-- Configure Tab Panel -->
        <p-tabpanel value="1">
          <div class="configure-content">
            <div *ngIf="!selectedScreener" class="no-selection">
              <i class="pi pi-cog" style="font-size: 3rem; color: #ccc;"></i>
              <p>Select a screener from the Overview tab to configure it, or create a new screener.</p>
              <button pButton label="Create New Screener" icon="pi pi-plus" (click)="createScreener()" class="p-button-primary"></button>
            </div>
            
            <div *ngIf="selectedScreener" class="screener-config">
              <div class="config-header">
                <h3>Configure Screener: {{ selectedScreener.name }}</h3>
                <button pButton icon="pi pi-times" (click)="clearSelection()" class="p-button-text" title="Close Configuration"></button>
              </div>
              
              <!-- Basic Information Section -->
              <div class="config-section">
                <h4 class="section-title">Basic Information</h4>
                <div class="config-form">
                  <!-- Name and Default Universe on same row -->
                  <div class="form-row">
                    <div class="form-group">
                      <label for="configName">Name *</label>
                      <input 
                        type="text" 
                        pInputText 
                        id="configName"
                        [(ngModel)]="screenerForm.name"
                        placeholder="Enter screener name"
                        class="w-full"
                      />
                    </div>
                    
                    <div class="form-group">
                      <label for="configUniverse">Default Universe</label>
                      <p-select 
                        id="configUniverse"
                        [(ngModel)]="screenerForm.defaultUniverse"
                        [options]="universeOptions"
                        placeholder="Select default universe"
                        class="w-full">
                      </p-select>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label for="configDescription">Description</label>
                    <textarea 
                      id="configDescription"
                      [(ngModel)]="screenerForm.description"
                      placeholder="Enter screener description"
                      rows="2"
                      class="w-full"
                    ></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label for="configVisibility">Visibility</label>
                    <div class="toggle-switch">
                      <label class="switch">
                        <input 
                          type="checkbox" 
                          id="configVisibility"
                          [(ngModel)]="screenerForm.isPublic"
                          (change)="onVisibilityChange($event)"
                        >
                        <span class="slider"></span>
                      </label>
                      <span class="toggle-label">{{ screenerForm.isPublic ? 'Public' : 'Private' }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Screening Criteria Section -->
              <div class="config-section">
                <div class="criteria-header">
                  <h4 class="section-title">Screening Criteria</h4>
                  <p class="criteria-description">
                    Define the technical indicators and conditions that stocks must meet to be included in this screener.
                    You can combine multiple conditions using AND/OR logic.
                  </p>
                </div>

                <!-- SQL Query Display -->
                <div class="sql-query-display">
                  <h5>Generated WHERE Condition:</h5>
                  <div class="sql-query-box">
                    <code>{{ getGeneratedWhereCondition() }}</code>
                  </div>
                </div>

                <!-- Query Builder with Custom Header Actions -->
                <div class="query-builder-container">
                  <div class="query-builder-header-custom">
                    <h5>Query Builder</h5>
                    <div class="query-builder-actions">
                      <button 
                        pButton 
                        label="Add Rule" 
                        icon="pi pi-plus" 
                        (click)="addRule()" 
                        class="p-button-outlined p-button-success p-button-sm"
                      ></button>
                      <button 
                        pButton 
                        label="Add Group" 
                        icon="pi pi-layer-group" 
                        (click)="addGroup()" 
                        class="p-button-outlined p-button-success p-button-sm"
                      ></button>
                      <button 
                        pButton 
                        label="Clear All Criteria" 
                        icon="pi pi-trash" 
                        (click)="clearCriteria()" 
                        class="p-button-outlined p-button-danger p-button-sm"
                        [disabled]="!hasCriteria()"
                      ></button>
                    </div>
                  </div>
                  
                  <app-query-builder
                    [query]="criteriaQuery"
                    [config]="criteriaConfig"
                    [hideHeader]="true"
                    (queryChange)="onCriteriaChange($event)">
                  </app-query-builder>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="config-actions">
                <div class="action-buttons-right">
                  <button pButton label="Cancel" icon="pi pi-times" (click)="clearSelection()" class="p-button-text"></button>
                  <button 
                    pButton 
                    label="Save Changes" 
                    icon="pi pi-check" 
                    (click)="saveScreener()" 
                    [disabled]="!screenerForm.name || loading"
                    [loading]="loading"
                  ></button>
                </div>
              </div>
            </div>
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>


  <!-- Toast Messages -->
  <p-toast></p-toast>
  
  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>
</div>
