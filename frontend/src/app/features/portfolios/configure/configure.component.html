<div class="configure-tab-content">
  @if (editingPortfolio) {
    <div class="portfolio-header">
      <div class="header-content">
        <!-- Edit Button at Top Right -->
        <div class="edit-controls">
          @if (!isEditing) {
            <button class="edit-all-btn" (click)="startEditAll()" title="Edit portfolio">
              <i class="pi pi-pencil"></i>
              Edit
            </button>
          } @else {
            <div class="edit-buttons">
              <button class="save-all-btn" 
                      (click)="saveEditAll()" 
                      title="Save all changes"
                      [disabled]="isSaving">
                @if (isSaving) {
                  <i class="pi pi-spin pi-spinner"></i>
                  Saving...
                } @else {
                  <i class="pi pi-check"></i>
                  Save
                }
              </button>
              <button class="cancel-btn" 
                      (click)="cancelEdit()" 
                      title="Cancel editing"
                      [disabled]="isSaving">
                <i class="pi pi-times"></i>
                Cancel
              </button>
            </div>
          }
        </div>

        <div class="portfolio-title-section">
          <!-- First row: Portfolio Name + Risk Profile -->
          <div class="title-row">
            <div class="portfolio-name">
              @if (!isEditing) {
                <span class="name-text">{{ editingPortfolio.name || 'Untitled Portfolio' }}</span>
              } @else {
                <textarea pInputTextarea 
                          [(ngModel)]="editingPortfolio.name"
                          placeholder="Enter portfolio name"
                          class="inline-edit-textarea"
                          rows="1"
                          autoResize="true"
                          [disabled]="isSaving">
                </textarea>
              }
            </div>
            
            <div class="risk-profile-inline">
              @if (!isEditing) {
                <span class="risk-text">[{{ editingPortfolio.riskProfile || 'Not set' }}]</span>
              } @else {
                <p-select [options]="riskProfileOptions" 
                         [(ngModel)]="editingPortfolio.riskProfile"
                         optionLabel="label"
                         optionValue="value"
                         placeholder="Select risk profile"
                         class="inline-edit-select"
                         [disabled]="isSaving">
                </p-select>
              }
            </div>
          </div>
          
          <!-- Second row: Description -->
          <div class="description-row">
            @if (!isEditing) {
              <span class="description-text">{{ editingPortfolio.description || 'No description provided' }}</span>
            } @else {
              <textarea pInputTextarea 
                        [(ngModel)]="editingPortfolio.description"
                        placeholder="Enter portfolio description (optional)"
                        class="inline-edit-textarea"
                        rows="2"
                        autoResize="true"
                        [disabled]="isSaving">
              </textarea>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Portfolio Holdings Table -->
    <div class="holdings-section">
      <div class="holdings-header">
        <h3>Portfolio Holdings</h3>
        @if (isLoadingHoldings) {
          <div class="loading-indicator">
            <i class="pi pi-spin pi-spinner"></i>
            Loading holdings...
          </div>
        }
      </div>

      @if (portfolioHoldings.length > 0) {
        <div class="holdings-table-container">
          <!-- Global Filter and Actions Row -->
          <div class="table-filter-row">
            <span class="p-input-icon-left">
              <i class="pi pi-search"></i>
              <input pInputText 
                     type="text" 
                     [(ngModel)]="globalFilterValue" 
                     (input)="onGlobalFilterChange($event)"
                     placeholder="Search holdings..." 
                     class="p-inputtext-sm" />
            </span>
            
            <div class="table-actions">
              <button pButton 
                      icon="pi pi-refresh" 
                      class="p-button-outlined p-button-sm"
                      (click)="refreshHoldings()"
                      title="Refresh holdings">
              </button>
              
              <button pButton 
                      label="Add Stock" 
                      icon="pi pi-plus" 
                      class="p-button-sm"
                      (click)="openAddStockDialog()"
                      title="Add stock to portfolio">
              </button>
            </div>
          </div>

          <p-table [value]="portfolioHoldings" 
                   styleClass="p-datatable-sm holdings-table"
                   [tableStyle]="{'min-width': '100%'}"
                   [scrollable]="true"
                   scrollHeight="400px"
                   [sortMode]="'multiple'"
                   [globalFilterFields]="['symbol']"
                   [showCurrentPageReport]="true"
                   currentPageReportTemplate="Showing {first} to {last} of {totalRecords} holdings"
                   [rowsPerPageOptions]="[5, 10, 25]"
                   [paginator]="true"
                   [rows]="10">
            
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 25%">Stock</th>
                <th style="width: 20%">LTP</th>
                <th style="width: 15%">Sector</th>
                <th style="width: 15%">Industry</th>
                <th style="width: 10%">Volume</th>
                <th style="width: 10%">VWAP</th>
                <th style="width: 5%">Actions</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-holding>
              <tr>
                <!-- Stock Column -->
                <td>
                  <div class="stock-info">
                    <div class="stock-symbol">{{ holding.symbol }}</div>
                    <div class="stock-name">{{ getMarketData(holding.symbol).name || holding.symbol + ' Limited' }}</div>
                  </div>
                </td>

                <!-- LTP Column -->
                <td>
                  <div class="ltp-info">
                    <div class="current-price">₹{{ (getMarketData(holding.symbol).currentPrice || 0) | number:'1.2-2' }}</div>
                    <div class="price-change" 
                         [ngClass]="(getMarketData(holding.symbol).change || 0) >= 0 ? 'positive' : 'negative'">
                      <i class="pi" 
                         [ngClass]="(getMarketData(holding.symbol).change || 0) >= 0 ? 'pi-arrow-up' : 'pi-arrow-down'">
                      </i>
                      {{ (getMarketData(holding.symbol).change || 0) >= 0 ? '+' : '' }}{{ (getMarketData(holding.symbol).changePercent || 0) | number:'1.2-2' }}%
                    </div>
                  </div>
                </td>

                <!-- Sector Column -->
                <td>
                  <span class="sector-tag">{{ getMarketData(holding.symbol).sector || 'Unknown' }}</span>
                </td>

                <!-- Industry Column -->
                <td>
                  <span class="industry-tag">{{ getMarketData(holding.symbol).industry || 'Unknown' }}</span>
                </td>

                <!-- Volume Column -->
                <td>
                  <div class="volume-info">
                    {{ (getMarketData(holding.symbol).volume || 0) | number:'1.0-0' }}
                  </div>
                </td>

                <!-- VWAP Column -->
                <td>
                  <div class="vwap-info">
                    ₹{{ (getMarketData(holding.symbol).vwap || 0) | number:'1.2-2' }}
                  </div>
                </td>

                <!-- Actions Column -->
                <td>
                  <button class="action-btn delete-btn" 
                          title="Remove holding"
                          (click)="removeHolding(holding)">
                    <i class="pi pi-trash"></i>
                  </button>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="7" class="text-center">
                  <div class="empty-holdings">
                    <i class="pi pi-info-circle"></i>
                    <p>No holdings found for this portfolio.</p>
                    <p>Add stocks to start building your portfolio.</p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      } @else if (!isLoadingHoldings) {
        <div class="no-holdings-message">
          <i class="pi pi-info-circle"></i>
          <h4>No Holdings</h4>
          <p>This portfolio doesn't have any holdings yet.</p>
          <button pButton 
                  label="Add Holdings" 
                  icon="pi pi-plus" 
                  class="p-button-outlined p-button-sm"
                  (click)="addHoldings()">
          </button>
        </div>
      }
    </div>
  } @else {
    <div class="no-selection-message">
      <i class="pi pi-info-circle"></i>
      <h3>No Portfolio Selected</h3>
      <p>Please select a portfolio from the Overview tab to configure it, or click "Create Portfolio" to create a new one.</p>
      <button pButton 
              label="Back to Overview" 
              icon="pi pi-arrow-left" 
              class="p-button-outlined"
              (click)="navigateToOverview()">
      </button>
    </div>
  }

  <!-- Add Stock Dialog -->
  <p-dialog header="Add Stock to Portfolio" 
            [(visible)]="showAddStockDialog" 
            [modal]="true" 
            [closable]="true"
            [draggable]="false"
            [resizable]="false"
            styleClass="add-stock-dialog"
            [style]="{width: '500px', height: '620px'}">
    
    <div class="add-stock-content">
      <!-- Stock Search -->
      <div class="stock-search-section">
        <label for="stockSearch" class="field-label">Search Stock</label>
        <div class="stock-search-input-container">
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input pInputText 
                   id="stockSearch"
                   type="text" 
                   [(ngModel)]="stockSearchQuery"
                   (input)="onStockSearchInput($event)"
                   placeholder="Type stock symbol or name..."
                   class="stock-search-input" />
          </span>
          @if (isSearchingStocks) {
            <div class="search-loading">
              <i class="pi pi-spin pi-spinner"></i>
            </div>
          }
        </div>
        
        <!-- Search Results -->
        @if (stockSearchResults.length > 0) {
          <div class="search-results">
            @for (stock of stockSearchResults; track stock.symbol) {
              <div class="search-result-item" 
                   (click)="selectStock(stock)"
                   [class.selected]="selectedStock?.symbol === stock.symbol">
                <div class="stock-info">
                  <div class="stock-symbol">{{ stock.symbol }}</div>
                  <div class="stock-name">{{ stock.name }}</div>
                </div>
                <div class="stock-price" *ngIf="stock.price && stock.price > 0">
                  ₹{{ stock.price | number:'1.2-2' }}
                </div>
              </div>
            }
          </div>
        } @else if (stockSearchQuery && stockSearchQuery.length >= 2 && !isSearchingStocks && !selectedStock) {
          <div class="no-results">
            <i class="pi pi-info-circle"></i>
            <span>No stocks found. Try a different search term.</span>
          </div>
        }
      </div>

      <!-- Selected Stock Info -->
      <div class="selected-stock-section" *ngIf="selectedStock">
        <h4>Selected Stock</h4>
        
        @if (isLoadingStockDetails) {
          <div class="loading-stock-details">
            <i class="pi pi-spin pi-spinner"></i>
            <span>Loading stock details...</span>
          </div>
        } @else if (selectedStockDetails) {
          <div class="selected-stock-info">
            <!-- Basic Stock Info - Company Name with Industry -->
            <div class="stock-basic-info">
              <div class="stock-symbol">{{ selectedStockDetails.symbol || selectedStock.symbol }}</div>
              <div class="stock-name-with-industry">
                {{ selectedStockDetails.name || selectedStock.name || selectedStock.companyName || (selectedStock.symbol + ' Limited') }}
                <span *ngIf="selectedStockDetails.industry"> - {{ selectedStockDetails.industry }}</span>
              </div>
            </div>
            
            <!-- Organized Market Data Rows -->
            <div class="stock-market-data">
              <!-- Open, Close Row -->
              <div class="market-data-row">
                <div class="market-item">
                  <span class="market-label">Open:</span>
                  <span class="market-value">₹{{ (selectedStockDetails.open || 0) | number:'1.2-2' }}</span>
                </div>
                <div class="market-item">
                  <span class="market-label">Close:</span>
                  <span class="market-value">₹{{ (selectedStockDetails.previousClose || 0) | number:'1.2-2' }}</span>
                </div>
              </div>
              
              <!-- High, Low Row -->
              <div class="market-data-row">
                <div class="market-item">
                  <span class="market-label">High:</span>
                  <span class="market-value">₹{{ (selectedStockDetails.dayHigh || 0) | number:'1.2-2' }}</span>
                </div>
                <div class="market-item">
                  <span class="market-label">Low:</span>
                  <span class="market-value">₹{{ (selectedStockDetails.dayLow || 0) | number:'1.2-2' }}</span>
                </div>
              </div>
              
              <!-- Change, Change % Row -->
              <div class="market-data-row">
                <div class="market-item">
                  <span class="market-label">Change:</span>
                  <span class="market-value">{{ (selectedStockDetails.change || 0) >= 0 ? '+' : '' }}₹{{ (selectedStockDetails.change || 0) | number:'1.2-2' }}</span>
                </div>
                <div class="market-item">
                  <span class="market-label">Change %:</span>
                  <span class="market-value">{{ (selectedStockDetails.changePercent || 0) >= 0 ? '+' : '' }}{{ (selectedStockDetails.changePercent || 0) | number:'1.2-2' }}%</span>
                </div>
              </div>
              
              <!-- Volume, VWAP Row -->
              <div class="market-data-row">
                <div class="market-item">
                  <span class="market-label">Volume:</span>
                  <span class="market-value">{{ (selectedStockDetails.volume || 0) | number:'1.0-0' }}</span>
                </div>
                <div class="market-item">
                  <span class="market-label">VWAP:</span>
                  <span class="market-value">₹{{ (selectedStockDetails.vwap || 0) | number:'1.2-2' }}</span>
                </div>
              </div>
            </div>
          </div>
        } @else {
          <!-- Fallback to basic info if details failed to load -->
          <div class="selected-stock-info">
            <div class="stock-basic-info">
              <div class="stock-symbol">{{ selectedStock.symbol }}</div>
              <div class="stock-name">{{ selectedStock.name || selectedStock.companyName }}</div>
            </div>
          </div>
        }
      </div>

      <!-- Quantity Input -->
      <div class="quantity-section" *ngIf="selectedStock">
        <label for="stockQuantity" class="field-label">Quantity</label>
        <input pInputText 
               id="stockQuantity"
               type="number" 
               [(ngModel)]="stockQuantity"
               placeholder="Enter quantity"
               min="0"
               class="quantity-input" />
        <small class="field-help">Default quantity is 0. You can modify this later.</small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <button pButton 
                label="Cancel" 
                icon="pi pi-times" 
                class="p-button-outlined"
                (click)="closeAddStockDialog()"
                [disabled]="isAddingStock">
        </button>
        <button pButton 
                label="Add Stock" 
                icon="pi pi-plus" 
                class="p-button"
                (click)="addSelectedStock()"
                [disabled]="!selectedStock || isAddingStock">
          @if (isAddingStock) {
            <i class="pi pi-spin pi-spinner"></i>
            Adding...
          }
        </button>
      </div>
    </ng-template>
  </p-dialog>
</div>
