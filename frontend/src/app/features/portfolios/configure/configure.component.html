<div class="configure-tab-content">
  @if (editingPortfolio) {
    <div class="portfolio-header">
      <div class="header-content">
        <!-- Edit Button at Top Right -->
        <div class="edit-controls">
          @if (!isEditing) {
            <button class="edit-all-btn" (click)="startEditAll()" title="Edit portfolio">
              <i class="pi pi-pencil"></i>
              Edit
            </button>
          } @else {
            <div class="edit-buttons">
              <button class="save-all-btn" 
                      (click)="saveEditAll()" 
                      title="Save all changes"
                      [disabled]="isSaving">
                @if (isSaving) {
                  <i class="pi pi-spin pi-spinner"></i>
                  Saving...
                } @else {
                  <i class="pi pi-check"></i>
                  Save
                }
              </button>
              <button class="cancel-btn" 
                      (click)="cancelEdit()" 
                      title="Cancel editing"
                      [disabled]="isSaving">
                <i class="pi pi-times"></i>
                Cancel
              </button>
            </div>
          }
        </div>

        <div class="portfolio-title-section">
          <!-- First row: Portfolio Name + Risk Profile -->
          <div class="title-row">
            <div class="portfolio-name">
              @if (!isEditing) {
                <span class="name-text">{{ editingPortfolio.name || 'Untitled Portfolio' }}</span>
              } @else {
                <textarea pInputTextarea 
                          [(ngModel)]="editingPortfolio.name"
                          placeholder="Enter portfolio name"
                          class="inline-edit-textarea"
                          rows="1"
                          autoResize="true"
                          [disabled]="isSaving">
                </textarea>
              }
            </div>
            
            <div class="risk-profile-inline">
              @if (!isEditing) {
                <span class="risk-text">[{{ editingPortfolio.riskProfile || 'Not set' }}]</span>
              } @else {
                <p-select [options]="riskProfileOptions" 
                         [(ngModel)]="editingPortfolio.riskProfile"
                         optionLabel="label"
                         optionValue="value"
                         placeholder="Select risk profile"
                         class="inline-edit-select"
                         [disabled]="isSaving">
                </p-select>
              }
            </div>
          </div>
          
          <!-- Second row: Description -->
          <div class="description-row">
            @if (!isEditing) {
              <span class="description-text">{{ editingPortfolio.description || 'No description provided' }}</span>
            } @else {
              <textarea pInputTextarea 
                        [(ngModel)]="editingPortfolio.description"
                        placeholder="Enter portfolio description (optional)"
                        class="inline-edit-textarea"
                        rows="2"
                        autoResize="true"
                        [disabled]="isSaving">
              </textarea>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Portfolio Holdings Table -->
    <div class="holdings-section">
      <div class="holdings-header">
        <h3>Portfolio Holdings</h3>
        <div class="holdings-actions">
          @if (isLoadingHoldings) {
            <div class="loading-indicator">
              <i class="pi pi-spin pi-spinner"></i>
              Loading holdings...
            </div>
          } @else {
            <button pButton 
                    icon="pi pi-refresh" 
                    class="p-button-outlined p-button-sm"
                    (click)="refreshHoldings()"
                    title="Refresh holdings">
            </button>
          }
        </div>
      </div>

      @if (portfolioHoldings.length > 0) {
        <div class="holdings-table-container">
          <!-- Global Filter -->
          <div class="table-filter">
            <span class="p-input-icon-left">
              <i class="pi pi-search"></i>
              <input pInputText 
                     type="text" 
                     [(ngModel)]="globalFilterValue" 
                     (input)="onGlobalFilterChange($event)"
                     placeholder="Search holdings..." 
                     class="p-inputtext-sm" />
            </span>
          </div>

          <p-table [value]="portfolioHoldings" 
                   styleClass="p-datatable-sm holdings-table"
                   [tableStyle]="{'min-width': '100%'}"
                   [scrollable]="true"
                   scrollHeight="400px"
                   [sortMode]="'multiple'"
                   [globalFilterFields]="['symbol']"
                   [showCurrentPageReport]="true"
                   currentPageReportTemplate="Showing {first} to {last} of {totalRecords} holdings"
                   [rowsPerPageOptions]="[5, 10, 25]"
                   [paginator]="true"
                   [rows]="10">
            
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 20%">Stock</th>
                <th style="width: 15%">LTP</th>
                <th style="width: 15%">Sector</th>
                <th style="width: 15%">Stage Analysis</th>
                <th style="width: 10%">Uptrend</th>
                <th style="width: 10%">Sector Trend</th>
                <th style="width: 10%">Sector Rank</th>
                <th style="width: 5%">Actions</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-holding>
              @if (getMockMarketData(holding.symbol).name) {
                <tr>
                  <!-- Stock Column -->
                  <td>
                    <div class="stock-info">
                      <div class="stock-symbol">{{ holding.symbol }}</div>
                      <div class="stock-name">{{ getMockMarketData(holding.symbol).name }}</div>
                    </div>
                  </td>

                  <!-- LTP Column -->
                  <td>
                    <div class="ltp-info">
                      <div class="current-price">â‚¹{{ getMockMarketData(holding.symbol).currentPrice | number:'1.2-2' }}</div>
                      <div class="price-change" 
                           [ngClass]="getMockMarketData(holding.symbol).change >= 0 ? 'positive' : 'negative'">
                        <i class="pi" 
                           [ngClass]="getMockMarketData(holding.symbol).change >= 0 ? 'pi-arrow-up' : 'pi-arrow-down'">
                        </i>
                        {{ getMockMarketData(holding.symbol).change >= 0 ? '+' : '' }}{{ getMockMarketData(holding.symbol).changePercent | number:'1.2-2' }}%
                      </div>
                    </div>
                  </td>

                  <!-- Sector Column -->
                  <td>
                    <span class="sector-tag">{{ getMockMarketData(holding.symbol).sector }}</span>
                  </td>

                  <!-- Stage Analysis Column -->
                  <td>
                    <div class="stage-analysis">
                      <span class="stage-tag stage-{{ getMockMarketData(holding.symbol).stageAnalysis.toLowerCase().replace(' ', '-') }}">
                        {{ getMockMarketData(holding.symbol).stageAnalysis }}
                      </span>
                      <div class="stage-label">{{ getMockMarketData(holding.symbol).stageLabel }}</div>
                    </div>
                  </td>

                  <!-- Uptrend Column -->
                  <td>
                    <span class="trend-tag" 
                          [ngClass]="getMockMarketData(holding.symbol).uptrend ? 'uptrend-yes' : 'uptrend-no'">
                      @if (getMockMarketData(holding.symbol).uptrend) {
                        <i class="pi pi-check"></i>
                        Yes
                      } @else {
                        <i class="pi pi-times"></i>
                        No
                      }
                    </span>
                  </td>

                  <!-- Sector Trend Column -->
                  <td>
                    <span class="sector-trend-tag">
                      <i class="pi pi-arrow-up"></i>
                      {{ getMockMarketData(holding.symbol).sectorTrend }}
                    </span>
                  </td>

                  <!-- Sector Rank Column -->
                  <td>
                    <div class="sector-rank">
                      <span class="rank-circle rank-{{ getMockMarketData(holding.symbol).sectorRank <= 3 ? 'top' : getMockMarketData(holding.symbol).sectorRank <= 5 ? 'middle' : 'bottom' }}">
                        {{ getMockMarketData(holding.symbol).sectorRank }}
                      </span>
                      <div class="rank-total">of {{ getMockMarketData(holding.symbol).totalSectorStocks }}</div>
                    </div>
                  </td>

                  <!-- Actions Column -->
                  <td>
                    <button class="action-btn delete-btn" 
                            title="Remove holding"
                            (click)="removeHolding(holding)">
                      <i class="pi pi-trash"></i>
                    </button>
                  </td>
                </tr>
              }
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="8" class="text-center">
                  <div class="empty-holdings">
                    <i class="pi pi-info-circle"></i>
                    <p>No holdings found for this portfolio.</p>
                    <p>Add stocks to start building your portfolio.</p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      } @else if (!isLoadingHoldings) {
        <div class="no-holdings-message">
          <i class="pi pi-info-circle"></i>
          <h4>No Holdings</h4>
          <p>This portfolio doesn't have any holdings yet.</p>
          <button pButton 
                  label="Add Holdings" 
                  icon="pi pi-plus" 
                  class="p-button-outlined p-button-sm"
                  (click)="addHoldings()">
          </button>
        </div>
      }
    </div>
  } @else {
    <div class="no-selection-message">
      <i class="pi pi-info-circle"></i>
      <h3>No Portfolio Selected</h3>
      <p>Please select a portfolio from the Overview tab to configure it, or click "Create Portfolio" to create a new one.</p>
      <button pButton 
              label="Back to Overview" 
              icon="pi pi-arrow-left" 
              class="p-button-outlined"
              (click)="navigateToOverview()">
      </button>
    </div>
  }
</div>
