import{c as m,e as b,k as S}from"./chunk-AR7LHXST.js";import{E as k,O as d,Q as a,U as p,Y as l,g as c,l as n,x as f,z as g}from"./chunk-53IN4TFO.js";var o={production:!1,apiUrl:"http://localhost:8080",enginesApiUrl:"http://localhost:8081/engines",enginesWebSocketUrl:"ws://localhost:8081/engines",enginesHttpUrl:"http://localhost:8081/engines",useMockData:!0,oauth:{google:{clientId:"your-google-client-id",redirectUri:"http://localhost:4200"},microsoft:{clientId:"your-microsoft-client-id",redirectUri:"http://localhost:4200"}}};var $=(()=>{let i=class i{constructor(e,t){this.http=e,this.router=t,this.currentUserSubject=new c(null),this.currentUser$=this.currentUserSubject.asObservable(),this.isAuthenticatedSubject=new c(!1),this.isAuthenticated$=this.isAuthenticatedSubject.asObservable(),this.initializeAuthState(),this.checkAuthStatus()}initializeAuthState(){this.getToken()&&!this.isTokenExpired()?this.isAuthenticatedSubject.next(!0):this.isAuthenticatedSubject.next(!1)}startTokenRefreshTimer(){f(8*60*60*1e3).pipe(d(()=>this.isLoggedIn()&&!this.isTokenExpired()?this.refreshToken():n(null))).subscribe({next:e=>{e&&e.success&&console.log("Token refreshed successfully")},error:e=>{console.error("Token refresh failed:",e),this.logout()}})}checkAuthStatus(){let e=new URLSearchParams(window.location.search),t=e.get("token"),r=e.get("error");if(r){console.error("OAuth2 error:",r),this.logout();return}if(t)this.setToken(t),window.history.replaceState({},document.title,window.location.pathname),this.validateToken(t).subscribe({next:s=>{this.currentUserSubject.next(s),this.isAuthenticatedSubject.next(!0),this.startTokenRefreshTimer(),this.router.navigate(["/dashboard"])},error:s=>{console.error("AuthService - Token validation failed:",s),this.logout()}});else{let s=this.getToken();s&&!this.isTokenExpired()?this.validateToken(s).subscribe({next:h=>{this.currentUserSubject.next(h),this.isAuthenticatedSubject.next(!0),this.startTokenRefreshTimer()},error:h=>{console.error("AuthService - Existing token validation failed:",h),this.logout()}}):this.clearAuthState()}}clearAuthState(){localStorage.removeItem("auth_token"),localStorage.removeItem("refresh_token"),this.currentUserSubject.next(null),this.isAuthenticatedSubject.next(!1)}validateToken(e){return this.http.get(`${o.apiUrl}/api/auth/validate`,{headers:new m({Authorization:`Bearer ${e}`})})}loginWithEmail(e){return this.http.post(`${o.apiUrl}/api/auth/email-login`,{email:e}).pipe(a(t=>{t.success&&t.token&&(this.setToken(t.token),t.user&&(this.currentUserSubject.next(t.user),this.isAuthenticatedSubject.next(!0),this.startTokenRefreshTimer()))}),g(t=>{console.error("Login error:",t);let r="Login failed. Please try again.";return t.error?.message?r=t.error.message:t.message&&(r=t.message),n({success:!1,message:r})}))}loginWithOAuth(e){let t=`${o.apiUrl}/oauth2/authorization/${e}`;window.location.href=t}logout(){localStorage.removeItem("auth_token"),this.currentUserSubject.next(null),this.isAuthenticatedSubject.next(!1),this.router.navigate(["/login"])}getToken(){return localStorage.getItem("auth_token")}setToken(e){localStorage.setItem("auth_token",e)}isLoggedIn(){return!this.getToken()||this.isTokenExpired()?!1:this.isAuthenticatedSubject.value}waitForAuthCheck(){return new Promise(e=>{if(this.isAuthenticatedSubject.value!==null){e(this.isAuthenticatedSubject.value);return}this.isAuthenticated$.pipe(k(1)).subscribe(t=>{e(t)})})}isTokenExpired(){let e=this.getToken();if(!e)return!0;try{let t=JSON.parse(atob(e.split(".")[1])),r=Date.now()/1e3;return t.exp<r}catch(t){return console.error("Error parsing token:",t),!0}}getCurrentUser(){return this.currentUserSubject.value}handleOAuthCallback(){return this.http.get(`${o.apiUrl}/api/auth/oauth-callback`).pipe(a(e=>{this.currentUserSubject.next(e),this.isAuthenticatedSubject.next(!0),this.router.navigate(["/dashboard"])}))}refreshToken(){let e=this.getToken();return e?this.http.post(`${o.apiUrl}/api/auth/refresh`,{token:e}).pipe(a(t=>{t.success&&t.token&&this.setToken(t.token)})):n({success:!1,message:"No token available"})}};i.\u0275fac=function(t){return new(t||i)(l(b),l(S))},i.\u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"});let u=i;return u})();export{o as a,$ as b};
