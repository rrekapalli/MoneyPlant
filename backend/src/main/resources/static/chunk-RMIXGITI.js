import{A as de,B as he,E as ue,G as pe,I as fe,M as ge,O as me,R as be,U as ye,X as Ce,Y as Se,a as oe,aa as De,ba as ke,ca as xe,da as Te,ia as Fe,la as ve,oa as Ve,qa as we,ra as Ie,x as ne,y as ce,z as le}from"./chunk-GZZ7RVNA.js";import{a as te,b as ie,c as Be,d as He}from"./chunk-EYRVMGKT.js";import{A as w,c as se,d as We,e as I,f as B,h as H,l as _,r as W,s as Ne,t as Pe,u as Ae,v as Me,w as Le,x as Oe,y,z as Ue}from"./chunk-AQB7DBB2.js";import"./chunk-DMPMDD2A.js";import"./chunk-ESE62B67.js";import{a as Ee}from"./chunk-2EE42365.js";import"./chunk-SOYPA3PZ.js";import{b as ae,c as re}from"./chunk-XIRLSLUI.js";import{b as _e}from"./chunk-33664Z76.js";import"./chunk-5QDLLTGU.js";import"./chunk-NBMXCGLL.js";import"./chunk-ZIWCRGVR.js";import"./chunk-4EIXSAPM.js";import"./chunk-E2A6ZCMF.js";import"./chunk-YETWNNB4.js";import{Ba as ee}from"./chunk-IDZOVNAK.js";import"./chunk-6DF6NXBA.js";import"./chunk-RSWLFW5Q.js";import"./chunk-AR7LHXST.js";import{Da as M,G as z,Ia as D,Jb as Z,Oa as j,Ra as G,Uc as Q,Wb as X,ca as v,da as V,jb as L,kb as O,lb as U,sc as K,tb as q,vb as E,y as $}from"./chunk-53IN4TFO.js";import{a as m,b,g as F}from"./chunk-GAL4ENT6.js";function R(){let h={values:[]};return new se().setId("filter-widget").setComponent("filter").setPosition({x:0,y:1,cols:12,rows:1}).setFilterOptions(h).build()}function N(h,u){let C=u||[];h.config?.options&&(h.config.options.values=C)}function P(h){h.config?.options&&(h.config.options.values=[])}var Je=!1,Re=h=>{try{h?.config?.options?h.config=b(m({},h.config),{options:m({},h.config.options)}):h?.config&&(h.config=m({},h.config)),h?.data&&(h.data=m({},h.data))}catch{}},$e=(h,u,C)=>F(null,null,function*(){if(!u||C?.connected===!0)return null;try{let e=yield u.getPreviousDayIndexData(h).toPromise();if(e&&e.indices&&e.indices.length>0)return e.indices[0]}catch(e){Je&&console.warn(`Failed to get fallback data for index ${h}:`,e)}return null}),A=h=>{try{return h?h.toString().toLowerCase().replace(/[^a-z0-9]/g,""):""}catch{return""}};function Y(h){let{indexName:u,initialPrice:C=0,initialPercent:e=0,initialHigh:t=0,initialLow:i=0,currency:a="\u20B9",webSocketService:r,indicesService:n,matchToName:l}=h,s=l||u,o=w.createStockTile(C,e,u,t,i,a).setPosition({x:0,y:0,cols:2,rows:2}).build(),c=()=>{try{r.subscribeToIndex(s).subscribe({next:d=>{if(d&&(d.indexName||d.indexSymbol)){let p=d.indexSymbol||d.indexName||"";if((A(p)!==""&&A(s)!==""?A(p)===A(s):!1)&&o?.config?.options){let g=d.lastPrice||0,k=d.percentChange||0,S=d.variation||0,x=d.dayHigh||0,Ye=d.dayLow||0,T=o.config.options;T.value=Number(g).toLocaleString(),T.change=`${S>=0?"+":""}${Number(S).toFixed(2)}`,T.changeType=k>=0?"positive":"negative",T.highValue=Number(x).toLocaleString(),T.lowValue=Number(Ye).toLocaleString(),T.description=d.indexName||d.indexSymbol||u,Re(o)}}},error:()=>{}})}catch{}};if(r)if(r.connected===!0)c();else{n&&$e(u,n,r).then(d=>{if(d&&o?.config?.options){let p=d.lastPrice||d.last||0,f=o.config.options;f.value=Number(p).toLocaleString(),f.change="Historical Data",f.changeType="neutral",f.highValue=Number(d.dayHigh||d.high||0).toLocaleString(),f.lowValue=Number(d.dayLow||d.low||0).toLocaleString(),Re(o)}}).catch(()=>{});try{r.connectionState?.subscribe?.(d=>{d===te.CONNECTED&&c()})}catch{}}return o}function J(h,u,C,e){if(!h)return ze(u,C,e);let t=h.length||0,i=h.filter(p=>(p.percentChange||0)<0).length,a=h.filter(p=>(p.percentChange||0)>0).length,r=h.filter(p=>(p.percentChange||0)===0).length,n=h.reduce((p,f)=>{let g=f.totalTradedValue||0;return isNaN(g)||!isFinite(g)?p:p+g},0)||0,l=h.reduce((p,f)=>{let g=f.totalTradedVolume||0;return isNaN(g)||!isFinite(g)?p:p+g},0)||0,s=isNaN(n)||!isFinite(n)?0:n,o=isNaN(l)||!isFinite(l)?0:l,c=[];if(u&&(u.indexName||u.index)&&(u.lastPrice!==void 0||u.last!==void 0)&&(u.lastPrice!==null||u.last!==null)&&(u.lastPrice!==0||u.last!==0)){let p=u.indexName||u.index||"Index",f=u.lastPrice||u.last||0,g=u.percentChange||0,k=u.dayHigh||u.high||0,S=u.dayLow||u.low||0;c.push(Y({indexName:p,initialPrice:f,initialPercent:g,initialHigh:k,initialLow:S,currency:"",webSocketService:C,indicesService:e,matchToName:u.index||u.indexName||p}))}else c.push(Y({indexName:"NIFTY 50",initialPrice:0,initialPercent:0,initialHigh:0,initialLow:0,currency:"\u20B9",webSocketService:C,indicesService:e,matchToName:"NIFTY 50"}));return c.push(y.createInfoTile("Declines",i.toString(),"Declining Stocks","fas fa-arrow-down","#dc2626").setBackgroundColor("#fecaca").setBorder("#f87171",1,8).setUpdateOnDataChange(!0).setPosition({x:2,y:0,cols:2,rows:2}).build(),y.createInfoTile("Advances",a.toString(),"Advancing Stocks","fas fa-arrow-up","#16a34a").setBackgroundColor("#bbf7d0").setBorder("#4ade80",1,8).setUpdateOnDataChange(!0).setPosition({x:4,y:0,cols:2,rows:2}).build(),y.createInfoTile("Unchanged",r.toString(),"Unchanged Stocks","fas fa-minus","#6b7280").setBackgroundColor("#e5e7eb").setBorder("#9ca3af",1,8).setUpdateOnDataChange(!0).setPosition({x:6,y:0,cols:2,rows:2}).build(),y.createFinancialTile(s,0,"Traded Value","\u20B9","fas fa-rupee-sign").setColor("#047857").setBackgroundColor("#a7f3d0").setBorder("#5eead4",1,8).setUpdateOnDataChange(!0).setPosition({x:8,y:0,cols:2,rows:2}).build(),y.createInfoTile("Traded Volume",o.toLocaleString(),"Total Volume","fas fa-chart-bar","#7c3aed").setBackgroundColor("#ddd6fe").setBorder("#a78bfa",1,8).setUpdateOnDataChange(!0).setPosition({x:10,y:0,cols:2,rows:2}).build()),c}function ze(h,u,C){return[Y({indexName:"NIFTY 50",initialPrice:0,initialPercent:0,initialHigh:0,initialLow:0,currency:"\u20B9",webSocketService:u,indicesService:C,matchToName:"NIFTY 50"}),y.createInfoTile("Declines","0","Declining Stocks","fas fa-arrow-down","#6b7280").setBackgroundColor("#f3f4f6").setBorder("#d1d5db",1,8).setUpdateOnDataChange(!0).setPosition({x:2,y:0,cols:2,rows:2}).build(),y.createInfoTile("Advances","0","Advancing Stocks","fas fa-arrow-up","#6b7280").setBackgroundColor("#f3f4f6").setBorder("#d1d5db",1,8).setUpdateOnDataChange(!0).setPosition({x:4,y:0,cols:2,rows:2}).build(),y.createInfoTile("Unchanged","0","Unchanged Stocks","fas fa-minus","#6b7280").setBackgroundColor("#f3f4f6").setBorder("#d1d5db",1,8).setUpdateOnDataChange(!0).setPosition({x:6,y:0,cols:2,rows:2}).build(),y.createFinancialTile(0,0,"Traded Value","\u20B9","fas fa-rupee-sign").setColor("#6b7280").setBackgroundColor("#f3f4f6").setBorder("#d1d5db",1,8).setUpdateOnDataChange(!0).setPosition({x:8,y:0,cols:2,rows:2}).build(),y.createInfoTile("Traded Volume","0","Total Volume","fas fa-chart-bar","#6b7280").setBackgroundColor("#f3f4f6").setBorder("#d1d5db",1,8).setUpdateOnDataChange(!0).setPosition({x:10,y:0,cols:2,rows:2}).build()]}var je=()=>({height:"100%",width:"100%","overflow-x":"hidden",overflow:"auto"});oe([Te,ke,Ce,Ie,we,Fe,Ve,Se,ve,xe,De,le,ce,de,he,fe,be,ue,pe,ye,ge,me,ne]);import("./chunk-A4EIW3BP.js").then(h=>{_.registerMap("world",h.default||h)}).catch(h=>{});var Nt=(()=>{let u=class u extends Le{constructor(e,t,i,a,r,n,l){super(e,t,i),this.componentCommunicationService=a,this.stockTicksService=r,this.indicesService=n,this.webSocketService=l,this.dashboardData=[],this.initialDashboardData=[],this.filteredDashboardData=this.dashboardData||[],this.appliedFilters=[],this.dashboardTitle="Financial Dashboard",this.selectedIndexSubscription=null,this.chartUpdateTimer=null,this.indicesWebSocketSubscription=null,this.webSocketConnectionStateSubscription=null,this.currentSelectedIndexData=null,this.historicalData=[],this.selectedTimeRange="1Y",this.isWebSocketConnected=!1,this.currentSubscribedIndex=null,this.isSubscribing=!1,this.subscribedTopics=new Set,this.enableDebugLogging=!1,this.lastPrevDayFetchIndex=null}ngOnInit(){super.ngOnInit?.()}onChildInit(){import("./chunk-A4EIW3BP.js").then(e=>{_.registerMap("world",e.default||e)}).catch(()=>{}),this.initializeWebSocket(),this.monitorWebSocketConnectionState(),this.selectedIndexSubscription&&(this.selectedIndexSubscription.unsubscribe(),this.selectedIndexSubscription=null),this.appliedFilters=[],this.dashboardTitle="Financial Dashboard",this.componentCommunicationService.clearSelectedIndex(),this.selectedIndexSubscription=this.componentCommunicationService.getSelectedIndex().pipe(z((e,t)=>{let i=e&&(e.name||e.symbol)||e,a=t&&(t.name||t.symbol)||t;return i===a})).subscribe(e=>{e?this.updateDashboardWithSelectedIndex(e):this.loadDefaultNifty50Data()}),setTimeout(()=>{this.componentCommunicationService.getSelectedIndex()||this.loadDefaultNifty50Data()},100)}onChildDestroy(){this.chartUpdateTimer&&(clearTimeout(this.chartUpdateTimer),this.chartUpdateTimer=null),this.dashboardConfig?.widgets&&this.dashboardConfig.widgets.forEach(e=>{if(e.chartInstance&&typeof e.chartInstance.dispose=="function")try{e.chartInstance.dispose(),e.chartInstance=null}catch(t){console.warn("Error disposing chart instance:",t)}}),this.selectedIndexSubscription&&(this.selectedIndexSubscription.unsubscribe(),this.selectedIndexSubscription=null),this.indicesWebSocketSubscription&&(this.indicesWebSocketSubscription.unsubscribe(),this.indicesWebSocketSubscription=null),this.webSocketConnectionStateSubscription&&(this.webSocketConnectionStateSubscription.unsubscribe(),this.webSocketConnectionStateSubscription=null),this.webSocketService.disconnect(),this.dashboardData=[],this.filteredDashboardData=null,this.appliedFilters=[],this.currentSelectedIndexData=null,this.historicalData=[],this.isWebSocketConnected=!1,this.currentSubscribedIndex=null,this.isSubscribing=!1,this.subscribedTopics.clear()}loadDefaultNifty50Data(){this.dashboardTitle="NIFTY 50 - Financial Dashboard",this.indicesService.getIndexByName("NIFTY 50").subscribe({next:e=>{if(e&&e.lastPrice!==void 0&&e.lastPrice!==null){let t={id:"NIFTY50",symbol:"NIFTY 50",name:"NIFTY 50",lastPrice:e.lastPrice||0,variation:e.variation||0,percentChange:e.percentChange||0,keyCategory:"Index"};this.updateDashboardWithSelectedIndex(t)}else this.loadDefaultNifty50DataFallback()},error:e=>{console.warn("Failed to get NIFTY 50 data from service, using fallback:",e),this.loadDefaultNifty50DataFallback()}})}loadDefaultNifty50DataFallback(){let e={id:"NIFTY50",symbol:"NIFTY 50",name:"NIFTY 50",lastPrice:0,variation:0,percentChange:0,keyCategory:"Index"};this.updateDashboardWithSelectedIndex(e)}loadStockTicksData(e){e&&e.trim()&&this.stockTicksService.getStockTicksByIndex(e).subscribe({next:t=>{this.dashboardData=t||[],this.appliedFilters=[],this.filteredDashboardData=this.dashboardData,this.updateMetricTilesWithFilters([]),this.populateWidgetsWithInitialData(),this.updateAllChartsWithFilteredData(),this.cdr.detectChanges()},error:()=>{this.dashboardData=[],this.filteredDashboardData=[],this.appliedFilters=[],this.updateMetricTilesWithFilters([]),this.updateAllChartsWithFilteredData(),this.cdr.detectChanges()}})}loadHistoricalData(e){e&&e.trim()&&this.indicesService.getIndexHistoricalData(e).subscribe({next:t=>{this.historicalData=t||[],this.updateCandlestickChartWithHistoricalData(),this.cdr.detectChanges()},error:t=>{console.warn("Failed to load historical data for",e,":",t),this.historicalData=[],this.updateCandlestickChartWithHistoricalData(),this.cdr.detectChanges()}})}clearAllWidgetsData(){if(!this.dashboardConfig?.widgets)return;this.dashboardConfig.widgets.filter(t=>t.config?.component==="echart").forEach(t=>{this.updateEchartWidget(t,[])})}unsubscribeFromCurrentWebSocketTopic(){if(this.indicesWebSocketSubscription&&(this.indicesWebSocketSubscription.unsubscribe(),this.indicesWebSocketSubscription=null),this.currentSubscribedIndex){let t=`/topic/nse-indices/${this.currentSubscribedIndex.replace(/\s+/g,"-").toLowerCase()}`;this.subscribedTopics.delete(t)}this.currentSubscribedIndex=null,this.isSubscribing=!1}updateDashboardWithSelectedIndex(e){this.unsubscribeFromCurrentWebSocketTopic(),this.dashboardTitle=e.name||e.symbol||"Financial Dashboard";let t=this.componentCommunicationService.transformToDashboardData(e);this.dashboardData=this.dashboardData.filter(r=>r.symbol!==t.symbol),this.dashboardData=[t,...this.dashboardData],this.currentSelectedIndexData={indexName:e.name||e.symbol,indexSymbol:e.symbol,lastPrice:e.lastPrice||0,variation:e.variation||0,percentChange:e.percentChange||0};let i=e.symbol;this.loadStockTicksData(i);let a=e.name||e.symbol;a&&(this.loadHistoricalData(a),this.subscribeToIndexWebSocket(a).catch(r=>{console.error("Failed to subscribe to WebSocket:",r)})),this.forceMetricTilesRefresh(),a&&(this.lastPrevDayFetchIndex=null,this.maybeFetchPreviousDay(a)),this.populateWidgetsWithInitialData(),this.cdr.detectChanges()}forceMetricTilesRefresh(){if(this.dashboardConfig?.widgets){this.dashboardConfig.widgets.filter(i=>i.config?.component==="tile"||i.config?.component==="stock-tile").forEach(i=>{let a=this.dashboardConfig.widgets.indexOf(i);a>-1&&this.dashboardConfig.widgets.splice(a,1)});let t=this.createMetricTiles(this.filteredDashboardData||this.dashboardData);this.dashboardConfig.widgets.unshift(...t)}this.updateMetricTilesWithFilters([]),this.cdr.detectChanges(),setTimeout(()=>{this.updateMetricTilesWithFilters([]),this.cdr.detectChanges()},100)}fetchAndUpdateCurrentIndexData(){if(!this.currentSelectedIndexData?.indexName)return;let e=this.currentSelectedIndexData.indexName;this.indicesService.getPreviousDayIndexData(e).subscribe({next:t=>{if(t&&t.indices&&t.indices.length>0){let i=t.indices[0];this.currentSelectedIndexData={indexName:i.indexName||i.index||e,indexSymbol:i.indexSymbol||e,lastPrice:i.lastPrice||i.last||0,variation:i.variation||0,percentChange:i.percentChange||0},this.updateMetricTilesWithFilters([]),this.cdr.detectChanges()}},error:t=>{console.warn(`Failed to fetch previous-day data for ${e}:`,t)}})}maybeFetchPreviousDay(e){e&&!this.isWebSocketConnected&&this.lastPrevDayFetchIndex!==e&&(this.lastPrevDayFetchIndex=e,this.fetchAndUpdateCurrentIndexData())}createMetricTiles(e){return J(this.filteredDashboardData||this.dashboardData,this.currentSelectedIndexData,this.webSocketService,this.indicesService)}updateMetricTilesWithFilters(e){if(!this.dashboardConfig?.widgets||this.dashboardConfig.widgets.length===0)return;let t=(this.dashboardConfig?.widgets||[]).filter(a=>a?.config?.component==="tile"||a?.config?.component==="stock-tile");if(!t.length)return;let i=this.createMetricTiles(this.filteredDashboardData||this.dashboardData);t.forEach((a,r)=>{if(r<i.length){let n=i[r];if(a?.config?.options?.updateOnDataChange!==!1){let o=n?.config?.options;if(a?.config?.component==="stock-tile"){let c={value:o?.value??"",change:o?.change??"",changeType:o?.changeType??"neutral",description:o?.description??"",icon:o?.icon??"",color:o?.color??"",backgroundColor:o?.backgroundColor??"",highValue:o?.highValue??"",lowValue:o?.lowValue??"",currency:o?.currency??"\u20B9"};w.updateData(a,c)}else{let c={value:o?.value??"",change:o?.change??"",changeType:o?.changeType??"neutral",description:o?.description??"",icon:o?.icon??"",color:o?.color??"",backgroundColor:o?.backgroundColor??"",title:o?.title??"",subtitle:o?.subtitle??o?.customData?.subtitle??""};y.updateData(a,c)}}}}),setTimeout(()=>{this.cdr?.detectChanges?.()},50)}initializeDashboardConfig(){let e=H.create().setData(this.filteredDashboardData||[]).setHeader("Industry").setCurrencyFormatter("INR","en-US").setPredefinedPalette("business").setTooltip("item",l=>{let s=new Intl.NumberFormat("en-US",{style:"currency",currency:"INR"});return`${l.name}: ${s.format(l.value)}`}).setAccessor("industry").setFilterColumn("industry",I.Value).setEvents((l,s)=>{s&&(s.off("click"),s.on("click",o=>{o.event?.stop?.();let c=o.name||o.data&&o.data.name;return c&&typeof c=="string"&&isNaN(Number(c))&&this.filterChartsByIndustry(c),!1}))}).setId("industry-bar-chart").setSkipDefaultFiltering(!0).build(),t=B.create().setData(this.filteredDashboardData).setHeader("Sector Allocation").setShowLegend(!1).setDonutStyle("40%","70%").setFinancialDisplay("INR","en-US").setPredefinedPalette("finance").setAccessor("sector").setFilterColumn("sector",I.Value).setEvents((l,s)=>{s&&(s.off("click"),s.on("click",o=>{o.event?.stop?.();let c=o.name||o.data&&o.data.name;return c&&typeof c=="string"&&isNaN(Number(c))&&this.filterChartsBySector(c),!1}))}).setId("sector-pie-chart").setSkipDefaultFiltering(!0).build(),i=W.create().setData([]).transformData({dateField:"date",openField:"open",closeField:"close",lowField:"low",highField:"high",sortBy:"date",sortOrder:"asc"}).setHeader("Index Historical Price Movement").setCurrencyFormatter("INR","en-IN").setPredefinedPalette("finance").setAccessor("symbol").setFilterColumn("symbol").setXAxisName("Trading Date").setYAxisName("Price (\u20B9)").setBarWidth("60%").setCandlestickColors("#00da3c","#ec0000","#808080").enableBrush().setLargeMode(100).setTooltipType("axis").enableTimeRangeFilters(["1D","5D","1M","3M","6M","YTD","1Y","3Y","5Y","MAX"],"1Y").enableAreaSeries(!0,.4).setAreaSeriesOpacity(.5).enableVolume(!1).enableLegend(!1).enableDataZoom(!0).setTimeRangeChangeCallback(this.handleTimeRangeChange.bind(this)).setEvents((l,s)=>{s&&(s.off("click"),s.on("click",o=>(o.event?.stop?.(),console.log("Candlestick chart clicked:",o),!1)))}).setId("candlestick-chart").setSkipDefaultFiltering(!0).build();if(i.config?.options){let l=i.config.options;l.xAxis={type:"category",data:[],boundaryGap:!1,splitLine:{show:!1},min:"dataMin",max:"dataMax",axisLabel:{rotate:45,fontSize:10,color:"#666",formatter:s=>{if(s&&typeof s=="string")try{let o=new Date(s);if(!isNaN(o.getTime()))return o.toLocaleDateString("en-IN",{month:"short",day:"numeric",year:"2-digit"})}catch{}return s}},axisTick:{alignWithLabel:!0},axisLine:{onZero:!1,lineStyle:{color:"#ddd"}}},l.yAxis={type:"value",scale:!0,splitArea:{show:!0},axisLabel:{formatter:s=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:0,maximumFractionDigits:2}).format(s),color:"#333",fontSize:10},axisLine:{lineStyle:{color:"#ddd"}},splitLine:{lineStyle:{color:"#f0f0f0",type:"dashed"}}},l.grid={top:"15%",left:"5%",right:"5%",bottom:"18%",containLabel:!0},l.tooltip=b(m({},l.tooltip),{trigger:"axis",axisPointer:{type:"cross",crossStyle:{color:"#999"}},formatter:s=>{let o=Array.isArray(s)?s[0]:s,c=o.data,d=o.name,p=d;try{let g=new Date(d);isNaN(g.getTime())||(p=g.toLocaleDateString("en-IN",{weekday:"short",year:"numeric",month:"short",day:"numeric"}))}catch{}let f=new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2});return`
            <div style="padding: 8px;">
              <div style="font-weight: bold; margin-bottom: 8px;">${p}</div>
              <div style="margin: 4px 0;">
                <span style="color: #666;">Open:</span> 
                <span style="font-weight: bold;">${f.format(c[0])}</span>
              </div>
              <div style="margin: 4px 0;">
                <span style="color: #666;">Close:</span> 
                <span style="font-weight: bold;">${f.format(c[1])}</span>
              </div>
              <div style="margin: 4px 0;">
                <span style="color: #666;">Low:</span> 
                <span style="font-weight: bold;">${f.format(c[2])}</span>
              </div>
              <div style="margin: 4px 0;">
                <span style="color: #666;">High:</span> 
                <span style="font-weight: bold;">${f.format(c[3])}</span>
              </div>
            </div>
          `}}),l.grid=b(m({},l.grid),{top:"15%",left:"5%",right:"5%",bottom:"18%",containLabel:!0}),l.dataZoom&&Array.isArray(l.dataZoom)&&l.dataZoom.forEach(s=>{s.type==="slider"&&(s.height="8%",s.bottom="1%")})}let a=Ue.create().setData(this.filteredDashboardData).setStockPerformanceConfiguration().setHeader("Stock List").setCurrencyFormatter("INR","en-IN").setPredefinedPalette("finance").setAccessor("symbol").setFilterColumn("symbol",I.Value).setId("stock-list-widget").build(),r=R(),n=this.createMetricTiles([]);r.position={x:0,y:2,cols:12,rows:1},i.position={x:0,y:3,cols:8,rows:12},a.position={x:8,y:3,cols:4,rows:16},e.position={x:0,y:15,cols:4,rows:8},t.position={x:4,y:15,cols:4,rows:8},this.dashboardConfig=Pe.createStandard().setDashboardId("overall-dashboard").enableFilterHighlighting(!0,{filteredOpacity:.25,highlightedOpacity:1,highlightColor:"#ff6b6b",filteredColor:"#e0e0e0"}).setWidgets([...n,r,e,t,i,a]).setEditMode(!1).build(),this.populateWidgetsWithInitialData()}populateWidgetsWithInitialData(){if(!this.dashboardConfig?.widgets)return;this.dashboardConfig.widgets.filter(i=>i.config?.component==="echart").forEach(i=>{let a=i.config?.header?.title,r=null;a&&(r=this.getFilteredDataForWidget(a)),r||(r=this.getSummarizedDataByWidget(a)),r&&this.updateEchartWidget(i,r)}),this.dashboardConfig.widgets.filter(i=>i.config?.component==="stock-list-table").forEach(i=>{let a=this.filteredDashboardData||this.dashboardData;a&&a.length>0?i.data?(i.data.stocks=a,i.data.isLoadingStocks=!1):i.data={stocks:a,isLoadingStocks:!1}:i.data?(i.data.stocks=[],i.data.isLoadingStocks=!1):i.data={stocks:[],isLoadingStocks:!1}}),this.updateMetricTilesWithFilters([]),this.triggerImmediateFallbackDataFetch(),setTimeout(()=>{this.cdr.detectChanges()},100)}triggerImmediateFallbackDataFetch(){if(!this.currentSelectedIndexData||!this.currentSelectedIndexData.lastPrice||this.currentSelectedIndexData.lastPrice===0){if(this.isWebSocketConnected)return;let e=this.currentSelectedIndexData?.indexName||"NIFTY 50";if(this.lastPrevDayFetchIndex===e)return;try{if(typeof navigator<"u"&&"onLine"in navigator&&navigator.onLine===!1){this.enableDebugLogging&&console.warn("Offline detected, skipping previous-day fetch");return}}catch{}this.lastPrevDayFetchIndex=e,this.indicesService.getPreviousDayIndexData(e).subscribe({next:t=>{if(t&&t.indices&&t.indices.length>0){let i=t.indices[0];this.currentSelectedIndexData={indexName:i.indexName||e,indexSymbol:i.indexSymbol||e,lastPrice:i.lastPrice||0,variation:i.variation||0,percentChange:i.percentChange||0},this.updateMetricTilesWithFilters([]),this.cdr.detectChanges()}},error:t=>{console.warn(`Failed to fetch previous-day data for ${e}:`,t)}})}}getSummarizedDataByWidget(e){let t=this.dashboardConfig.widgets.find(a=>a.config?.header?.title===e);if(!t||!t.config?.options?.series?.[0])return null;switch(e){case"Sector Allocation":return this.groupByAndSum(this.filteredDashboardData||this.dashboardData,"sector","totalTradedValue");case"Industry":return this.groupByAndSum(this.filteredDashboardData||this.dashboardData,"industry","totalTradedValue");case"Portfolio Distribution":return this.groupByAndSum(this.filteredDashboardData||this.dashboardData,"industry","totalTradedValue");case"Index Historical Price Movement":if(this.historicalData.length>0){let a=this.historicalData.map(n=>[n.open,n.close,n.low,n.high]),r=this.historicalData.map(n=>new Date(n.date).toISOString().split("T")[0]);return{data:a,xAxisLabels:r}}else{let a=this.filteredDashboardData||this.dashboardData;if(!a||a.length===0)return[];let r=a.map(l=>[l.openPrice||0,l.lastPrice||0,l.dayLow||0,l.dayHigh||0]),n=a.map(l=>l.symbol||"Unknown");return{data:r,xAxisLabels:n}}default:return null}}getFilteredDataForWidget(e,t){let i=t||this.filteredDashboardData||this.dashboardData;switch(e){case"Sector Allocation":if(!i)return[];let a=i.reduce((s,o)=>{let c=o.sector||"Unknown",d=o.totalTradedValue||0;return s[c]||(s[c]=0),s[c]+=d,s},{});return Object.entries(a).map(([s,o])=>({name:s,value:o})).sort((s,o)=>o.value-s.value);case"Industry":if(!i)return[];let r=i.reduce((s,o)=>{let c=o.industry||"Unknown",d=o.totalTradedValue||0;return s[c]||(s[c]=0),s[c]+=d,s},{}),n=["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc"];return Object.entries(r).map(([s,o])=>({name:s,value:o})).sort((s,o)=>o.value-s.value).map((s,o)=>b(m({},s),{itemStyle:{color:n[o%n.length]}}));case"Portfolio Distribution":if(!i)return[];let l=i.reduce((s,o)=>{let c=o.macro||"Unknown Macro",d=o.industry||"Unknown Industry",p=o.sector||"Unknown Sector",f=o.totalTradedValue||0;return s[c]||(s[c]={}),s[c][d]||(s[c][d]={}),s[c][d][p]||(s[c][d][p]=0),s[c][d][p]+=f,s},{});return Object.entries(l).map(([s,o])=>{let c=Object.entries(o).map(([p,f])=>{let g=Object.entries(f).map(([S,x])=>({name:S,value:x})),k=g.reduce((S,x)=>S+x.value,0);return{name:p,value:k,children:g}}),d=c.reduce((p,f)=>p+f.value,0);return{name:s,value:d,children:c}}).sort((s,o)=>o.value-s.value);case"Index Historical Price Movement":if(this.historicalData.length>0){let s=this.historicalData.map(c=>[c.open,c.close,c.low,c.high]),o=this.historicalData.map(c=>new Date(c.date).toISOString().split("T")[0]);return{data:s,xAxisLabels:o}}else{if(!i)return[];let s=i.map(c=>[c.openPrice||0,c.lastPrice||0,c.dayLow||0,c.dayHigh||0]),o=i.map(c=>{if(c.lastUpdateTime)try{let d=new Date(c.lastUpdateTime);if(!isNaN(d.getTime()))return d.toISOString().split("T")[0]}catch{}return c.symbol||"Unknown"});return{data:s,xAxisLabels:o}}default:return null}}applyEnhancedFilters(e){if(!this.dashboardConfig?.widgets)return;let t=this.dashboardData;if(e&&e.length>0){let i=e.map(a=>({property:a.filterColumn||"industry",operator:"equals",value:a.value}));t=We.applyFilters(t,i)}this.filteredDashboardData=t,this.updateAllChartsWithFilteredData(),setTimeout(()=>this.cdr.detectChanges(),100)}createStockTicksTreemapData(e){if(!e||e.length===0)return[];let t=new Map;return e.forEach(i=>{let a=i.macro||"Other";t.has(a)||t.set(a,[]),t.get(a).push(i)}),Array.from(t.entries()).map(([i,a])=>{let r=new Map;a.forEach(s=>{let o=s.industry||"Other";r.has(o)||r.set(o,[]),r.get(o).push(s)});let n=Array.from(r.entries()).map(([s,o])=>{let c=new Map;o.forEach(f=>{let g=f.sector||"Other";c.has(g)||c.set(g,[]),c.get(g).push(f)});let d=Array.from(c.entries()).map(([f,g])=>{let k=g.reduce((S,x)=>S+(x.lastPrice||0),0);return{name:f,value:k}}),p=d.reduce((f,g)=>f+g.value,0);return{name:s,value:p,children:d}}),l=n.reduce((s,o)=>s+o.value,0);return{name:i,value:l,children:n}})}applyFilters(){if(!this.dashboardData||this.dashboardData.length===0){this.filteredDashboardData=[],this.updateAllChartsWithFilteredData();return}if(this.appliedFilters.length===0){this.filteredDashboardData=[...this.dashboardData],this.updateAllChartsWithFilteredData();return}let e=[...this.dashboardData];for(let t of this.appliedFilters)e=this.applyIndividualFilter(e,t);this.filteredDashboardData=e,this.updateAllChartsWithFilteredData()}applyIndividualFilter(e,t){let i=t.operator||"equals";return e.filter(a=>{let r=a[t.field];switch(i){case"equals":return r===t.value;case"contains":return r&&r.toString().toLowerCase().includes(t.value.toString().toLowerCase());case"greaterThan":return r>t.value;case"lessThan":return r<t.value;default:return r===t.value}})}convertFilterCriteriaToIFilterValues(e){let t=typeof e.value=="number"?e.value.toString():e.value,a=`${this.getFieldDisplayName(e.field)}: '${e.value}'`,r=0;return typeof e.value=="string"&&(r=this.getAggregatedValueForCategory(e.field,e.value)),{accessor:e.field,filterColumn:e.field,category:t,value:t,numericValue:r.toString(),percentage:r.toString(),[e.field]:t,displayValue:a,source:e.source||"Unknown"}}getAggregatedValueForCategory(e,t){return!this.dashboardData||this.dashboardData.length===0?0:this.dashboardData.filter(i=>i[e]===t).reduce((i,a)=>i+(a.totalTradedValue||0),0)}getFieldDisplayName(e){switch(e){case"industry":return"Industry";case"sector":return"Sector";case"macro":return"Macro";case"symbol":return"Symbol";default:return e.charAt(0).toUpperCase()+e.slice(1)}}getFilterWidget(){return this.dashboardConfig?.widgets?.find(e=>e.id==="filter-widget"||e.config?.component==="filter")}updateFilterWidget(){let e=this.getFilterWidget();if(e){let t=this.appliedFilters.map(i=>this.convertFilterCriteriaToIFilterValues(i));N(e,t),this.cdr.detectChanges()}}addFilter(e){this.appliedFilters.some(i=>i.type===e.type&&i.field===e.field&&i.value===e.value)?this.appliedFilters=this.appliedFilters.filter(i=>!(i.type===e.type&&i.field===e.field&&i.value===e.value)):this.appliedFilters=this.appliedFilters.filter(i=>!(i.type===e.type&&i.field===e.field)),this.appliedFilters.push(e),this.applyFilters(),this.updateFilterWidget()}removeFilter(e,t){this.appliedFilters=this.appliedFilters.filter(i=>!(i.type===e&&i.field===t)),this.applyFilters(),this.updateFilterWidget()}clearAllFilters(){this.appliedFilters=[],this.filteredDashboardData=[...this.dashboardData||[]],this.applyFilters(),this.updateAllChartsWithFilteredData();let e=this.getFilterWidget();e&&P(e),this.cdr.detectChanges(),setTimeout(()=>{this.cdr.markForCheck(),this.cdr.detectChanges()},50),super.clearAllFilters()}onFilterValuesChanged(e){if(!e||e.length===0){this.appliedFilters=[],this.filteredDashboardData=[...this.dashboardData||[]],this.updateAllChartsWithFilteredData();let r=this.getFilterWidget();r&&P(r),this.cdr.detectChanges();return}let t=e.map(r=>r.category&&typeof r.category=="string"&&typeof r.value=="number"&&!isNaN(r.value)?b(m({},r),{value:r.category,category:r.category,numericValue:r.value}):r),i=this.getFilterWidget();i&&N(i,t);let a=[];t.forEach(r=>{let n=r.category||r.value;r.filterColumn==="sector"&&n&&typeof n=="string"&&isNaN(Number(n))?a.push({type:"sector",field:"sector",value:n,operator:"equals",source:"Filter Widget"}):r.filterColumn==="industry"&&n&&typeof n=="string"&&isNaN(Number(n))?a.push({type:"industry",field:"industry",value:n,operator:"equals",source:"Filter Widget"}):r.filterColumn==="symbol"&&n&&typeof n=="string"&&isNaN(Number(n))&&a.push({type:"symbol",field:"symbol",value:n,operator:"equals",source:"Filter Widget"})}),this.appliedFilters=a,this.applyFilters()}updateAllChartsWithFilteredData(){this.filteredDashboardData&&(this.chartUpdateTimer&&clearTimeout(this.chartUpdateTimer),this.chartUpdateTimer=setTimeout(()=>{this.updateBarChartWithFilteredData(),this.updatePieChartWithFilteredData(),this.historicalData.length>0?this.updateCandlestickChartWithHistoricalData():this.updateCandlestickChartWithFilteredData(),this.updateStockListWithFilteredData(),this.updateMetricTilesWithFilters([]),this.cdr.detectChanges(),this.chartUpdateTimer=null},150))}filterChartsByIndustry(e){!this.dashboardData||this.dashboardData.length===0||typeof e!="string"||!isNaN(Number(e))||![...new Set(this.dashboardData.map(i=>i.industry))].includes(e)||this.addFilter({type:"industry",field:"industry",value:e,operator:"equals",source:"Industry Chart"})}filterChartsBySector(e){!this.dashboardData||this.dashboardData.length===0||typeof e!="string"||!isNaN(Number(e))||![...new Set(this.dashboardData.map(i=>i.sector))].includes(e)||this.addFilter({type:"sector",field:"sector",value:e,operator:"equals",source:"Sector Chart"})}filterChartsByMacro(e){!this.dashboardData||this.dashboardData.length===0||this.addFilter({type:"macro",field:"macro",value:e,operator:"equals",source:"Treemap Chart"})}filterChartsBySymbol(e){!this.dashboardData||this.dashboardData.length===0||typeof e!="string"||!isNaN(Number(e))||![...new Set(this.dashboardData.map(i=>i.symbol))].includes(e)||this.addFilter({type:"symbol",field:"symbol",value:e,operator:"equals",source:"Candlestick Chart"})}updatePieChartWithFilteredData(){if(!this.dashboardConfig?.widgets||!this.filteredDashboardData)return;let e=this.dashboardConfig.widgets.find(t=>t.config?.header?.title==="Sector Allocation");if(e){let t=this.filteredDashboardData.reduce((a,r)=>{let n=r.sector||"Unknown";return a[n]||(a[n]=0),a[n]+=r.totalTradedValue||0,a},{}),i=Object.entries(t).map(([a,r])=>({name:a,value:r})).sort((a,r)=>r.value-a.value);try{if(B.updateData(e,i),e.chartInstance&&typeof e.chartInstance.setOption=="function"){let a=b(m({},e.config?.options),{series:[b(m({},e.config?.options?.series?.[0]||{}),{data:i})]});e.chartInstance.setOption(a,!0)}this.updateEchartWidget(e,i)}catch{}}}updateBarChartWithFilteredData(){if(!this.dashboardConfig?.widgets||!this.filteredDashboardData)return;let e=this.dashboardConfig.widgets.find(t=>t.config?.header?.title==="Industry");if(e){let t=this.filteredDashboardData.reduce((r,n)=>{let l=n.industry||"Unknown";return r[l]||(r[l]=0),r[l]+=n.totalTradedValue||0,r},{}),i=["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc"],a=Object.entries(t).map(([r,n])=>({name:r,value:n})).sort((r,n)=>n.value-r.value).map((r,n)=>b(m({},r),{itemStyle:{color:i[n%i.length]}}));try{if(H.updateData(e,a),e.chartInstance&&typeof e.chartInstance.setOption=="function"){let r=b(m({},e.config?.options),{series:[b(m({},e.config?.options?.series?.[0]||{}),{data:a})],yAxis:b(m({},e.config?.options?.yAxis||{}),{data:a.map(n=>n.name)})});e.chartInstance.setOption(r,!0)}this.updateEchartWidget(e,a)}catch{}}}safelyDisposeChartInstance(e){if(e.chartInstance&&typeof e.chartInstance.dispose=="function")try{e.chartInstance.dispose(),e.chartInstance=null}catch(t){console.warn("Error disposing chart instance:",t)}}updateCandlestickChartWithHistoricalData(){if(!this.dashboardConfig?.widgets)return;let e=this.dashboardConfig.widgets.find(t=>t.config?.header?.title==="Index Historical Price Movement with Volume");if(e&&this.historicalData.length>0){if(this.safelyDisposeChartInstance(e),W.updateData(e,this.historicalData),e.config?.options){let t=e.config.options;if(t.xAxis){let i=this.historicalData.map(a=>new Date(a.date).toISOString().split("T")[0]);t.xAxis.data=i}if(t.series&&t.series[0]){let i=this.historicalData.map(a=>[a.open,a.close,a.low,a.high]);t.series[0].data=i}}e.chartInstance&&typeof e.chartInstance.setOption=="function"&&setTimeout(()=>{e.chartInstance&&typeof e.chartInstance.resize=="function"&&e.chartInstance.resize()},100)}}updateCandlestickChartWithFilteredData(){if(!this.dashboardConfig?.widgets||!this.filteredDashboardData)return;let e=this.dashboardConfig.widgets.find(t=>t.config?.header?.title==="Index Historical Price Movement with Volume");if(e){this.safelyDisposeChartInstance(e);let t=this.filteredDashboardData.map(a=>[a.openPrice||0,a.lastPrice||0,a.dayLow||0,a.dayHigh||0]),i=this.filteredDashboardData.map(a=>{if(a.lastUpdateTime)try{let r=new Date(a.lastUpdateTime);if(!isNaN(r.getTime()))return r.toISOString().split("T")[0]}catch{}return a.symbol||"Unknown"});if(this.updateEchartWidget(e,t),e.chartInstance&&typeof e.chartInstance.setOption=="function"){let a=e.chartInstance.getOption(),r=b(m({},a),{xAxis:b(m({},a?.xAxis||{}),{data:i}),series:[b(m({},a?.series?.[0]||{}),{data:t})]});e.chartInstance.setOption(r,!0),setTimeout(()=>{e.chartInstance&&typeof e.chartInstance.resize=="function"&&e.chartInstance.resize()},100)}if(e.config?.options){let a=e.config.options;a.xAxis&&(a.xAxis.data=i),a.series&&a.series[0]&&(a.series[0].data=t)}}}updateTreemapWithFilteredData(){if(!this.dashboardConfig?.widgets||!this.filteredDashboardData)return;let e=this.dashboardConfig.widgets.find(t=>t.config?.header?.title==="Portfolio Distribution");if(e){let t=this.createStockTicksTreemapData(this.filteredDashboardData);this.updateEchartWidget(e,t)}}updateStockListWithFilteredData(){if(!this.dashboardConfig?.widgets)return;let e=this.dashboardConfig.widgets.filter(t=>t.config?.component==="stock-list-table");e.forEach(t=>{let a=[...this.filteredDashboardData||[]];t.data?(t.data.stocks=a,t.data.isLoadingStocks=!1):t.data={stocks:a,isLoadingStocks:!1}}),setTimeout(()=>{this.cdr.detectChanges(),e.forEach(t=>{t.data&&typeof t.data.refresh=="function"&&t.data.refresh()}),this.cdr.markForCheck()},50)}initializeWebSocket(){return F(this,null,function*(){try{yield this.webSocketService.connect()}catch{}})}subscribeToIndexWebSocket(e){return F(this,null,function*(){if(this.isSubscribing)return;let t=e.replace(/\s+/g,"-").toLowerCase(),i=`/topic/nse-indices/${t}`;if(!this.subscribedTopics.has(i)){this.indicesWebSocketSubscription&&(this.indicesWebSocketSubscription.unsubscribe(),this.indicesWebSocketSubscription=null),this.currentSubscribedIndex=e,this.isSubscribing=!0;try{if(this.webSocketService.connected||(yield new Promise((a,r)=>{let n=setTimeout(()=>{r(new Error("WebSocket connection timeout"))},1e4),l=this.webSocketService.connectionState.pipe($(s=>s==="CONNECTED")).subscribe({next:()=>{clearTimeout(n),l.unsubscribe(),a()},error:s=>{clearTimeout(n),l.unsubscribe(),r(s)}})})),this.webSocketService.connected)try{this.indicesWebSocketSubscription=this.webSocketService.subscribeToIndex(t).subscribe({next:a=>{this.handleWebSocketData(a,e)},error:a=>{console.warn(`Specific index subscription failed for ${t}, falling back to all indices:`,a.message||a),this.subscribeToAllIndicesAsFallback(e)},complete:()=>{}}),this.subscribedTopics.add(i)}catch(a){console.warn(`Specific index subscription failed for ${t}, falling back to all indices:`,a),this.subscribeToAllIndicesAsFallback(e)}else console.warn("WebSocket still not connected - skipping real-time subscription for",t)}catch(a){console.warn(`WebSocket subscription failed for ${t} - continuing without real-time data:`,a.message||a),this.cdr.detectChanges()}finally{this.isSubscribing=!1}}})}subscribeToAllIndicesAsFallback(e){try{this.indicesWebSocketSubscription=this.webSocketService.subscribeToAllIndices().subscribe({next:t=>{if(t&&t.indices&&t.indices.length>0){let i=t.indices.find(a=>{let r=a.indexName||a.index||"",n=a.indexSymbol||a.key||"";return r.toLowerCase().includes(e.toLowerCase())||n.toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(r.toLowerCase())||e.toLowerCase().includes(n.toLowerCase())});i&&this.handleWebSocketData(i,e)}},error:t=>{console.warn("All indices subscription error:",t.message||t),this.cdr.detectChanges()},complete:()=>{}})}catch(t){console.error("Failed to subscribe to all indices as fallback:",t)}}handleWebSocketData(e,t){try{if(e&&(e.indexName||e.indexSymbol)){if(this.currentSelectedIndexData=e,!this.dashboardConfig?.widgets||this.dashboardConfig.widgets.length===0){console.warn("Dashboard not ready yet, deferring first tile update"),setTimeout(()=>{this.updateFirstTileWithRealTimeData(e)},1e3);return}if(this.chartUpdateTimer)return;this.chartUpdateTimer=setTimeout(()=>{try{this.updateFirstTileWithRealTimeData(e),this.recreateMetricTiles(),this.cdr.detectChanges()}finally{this.chartUpdateTimer=null}},250)}else console.warn("WebSocket received data but no valid index data found:",e)}catch(i){console.error("Error processing received index data:",i)}}attemptWebSocketReconnection(){return F(this,null,function*(){if(this.currentSubscribedIndex)try{yield this.webSocketService.connect(),this.webSocketService.connected&&this.subscribeToIndexWebSocket(this.currentSubscribedIndex)}catch(e){console.warn("WebSocket reconnection failed:",e),setTimeout(()=>{this.attemptWebSocketReconnection()},5e3)}})}updateFirstTileWithRealTimeData(e){if(!this.dashboardConfig?.widgets||this.dashboardConfig.widgets.length===0){setTimeout(()=>{this.updateFirstTileWithRealTimeData(e)},500);return}let t=this.dashboardConfig.widgets.find(i=>i.position?.x===0&&i.position?.y===0&&(i.config?.component==="stock-tile"||i.config?.component==="tile"));if(t||(t=this.dashboardConfig.widgets.find(i=>i.config?.component==="stock-tile"||i.config?.component==="tile")),t||(t=this.dashboardConfig.widgets.find(i=>i.config?.header?.title?.toLowerCase().includes("nifty")||i.config?.header?.title?.toLowerCase().includes("index")||i.config?.header?.title?.toLowerCase().includes("price"))),!t){console.warn("No suitable tile found for real-time updates");return}if(!e){console.warn("No real-time index data available for first tile update");return}try{let i=e.indexName||e.indexSymbol||"Index",a=e.lastPrice||0,r=e.percentChange||0,n=e.dayHigh||0,l=e.dayLow||0,s=e.variation||0;if(t.config?.component==="stock-tile"){let o={value:a.toFixed(2),change:s.toFixed(2),changeType:r>=0?"positive":"negative",description:i,icon:"fas fa-chart-line",color:r>=0?"#16a34a":"#dc2626",backgroundColor:r>=0?"#bbf7d0":"#fecaca",highValue:n.toFixed(2),lowValue:l.toFixed(2),currency:"\u20B9"};w.updateData(t,o),t.data=m(m({},t.data),o)}else{let o={value:a.toFixed(2),change:s.toFixed(2),changeType:r>=0?"positive":"negative",description:i,icon:"fas fa-chart-line",color:r>=0?"#16a34a":"#dc2626",backgroundColor:r>=0?"#bbf7d0":"#fecaca",title:i,subtitle:`Change: ${r.toFixed(2)}%`};y.updateData(t,o),t.data=m(m({},t.data),o)}this.cdr.markForCheck(),this.cdr.detectChanges()}catch(i){console.error("Error updating first tile with real-time data:",i)}}forceDashboardRefresh(){this.updateMetricTilesWithFilters([]),this.cdr.detectChanges()}forceTileRefresh(){console.log("\u{1F504} Manual tile refresh triggered from dashboard header"),this.updateMetricTilesWithFilters([]),this.cdr.markForCheck(),this.cdr.detectChanges(),setTimeout(()=>{this.cdr.detectChanges(),console.log("\u{1F504} Manual tile refresh completed")},100)}recreateMetricTiles(){let e=this.dashboardConfig.widgets.filter(i=>i.config?.component==="tile"||i.config?.component==="stock-tile"),t=this.createMetricTiles(this.filteredDashboardData||this.dashboardData);e.forEach((i,a)=>{if(a<t.length){let r=t[a];if(i.config?.options?.updateOnDataChange!==!1){let s=r.config?.options;if(i.config?.component==="stock-tile"){let o={value:s?.value||"",change:s?.change||"",changeType:s?.changeType||"neutral",description:s?.description||"",icon:s?.icon||"",color:s?.color||"",backgroundColor:s?.backgroundColor||"",highValue:s?.highValue||"",lowValue:s?.lowValue||"",currency:s?.currency||"\u20B9"};w.updateData(i,o)}else{let o={value:s?.value||"",change:s?.change||"",changeType:s?.changeType||"neutral",description:s?.description||"",icon:s?.icon||"",color:s?.color||"",backgroundColor:s?.backgroundColor||"",title:s?.title||"",subtitle:s?.subtitle||s?.customData?.subtitle||""};y.updateData(i,o)}}}})}handleTimeRangeChange(e){console.log("Time range changed to:",e.range),this.selectedTimeRange=e.range;let t=this.filterHistoricalDataByTimeRange(e.range);if(this.dashboardConfig?.widgets){let i=this.dashboardConfig.widgets.find(a=>a.config?.header?.title==="Index Historical Price Movement");i&&t.length>0&&(this.safelyDisposeChartInstance(i),W.updateData(i,t),this.cdr.detectChanges())}}filterHistoricalDataByTimeRange(e){if(!this.historicalData||this.historicalData.length===0)return[];let t=new Date,i=new Date;switch(e){case"1D":i.setDate(t.getDate()-1);break;case"5D":i.setDate(t.getDate()-5);break;case"1M":i.setMonth(t.getMonth()-1);break;case"3M":i.setMonth(t.getMonth()-3);break;case"6M":i.setMonth(t.getMonth()-6);break;case"YTD":i=new Date(t.getFullYear(),0,1);break;case"1Y":i.setFullYear(t.getFullYear()-1);break;case"3Y":i.setFullYear(t.getFullYear()-3);break;case"5Y":i.setFullYear(t.getFullYear()-5);break;case"MAX":return this.historicalData;default:i.setFullYear(t.getFullYear()-1)}return this.historicalData.filter(a=>{let r=new Date(a.date);return r>=i&&r<=t})}monitorWebSocketConnectionState(){this.webSocketConnectionStateSubscription=this.webSocketService.connectionState.subscribe({next:e=>{if(this.isWebSocketConnected=e==="CONNECTED",this.isWebSocketConnected){if(this.currentSubscribedIndex&&!this.isSubscribing){let i=`/topic/nse-indices/${this.currentSubscribedIndex.replace(/\s+/g,"-").toLowerCase()}`;this.subscribedTopics.has(i)||this.subscribeToIndexWebSocket(this.currentSubscribedIndex)}}else(e==="DISCONNECTED"||e==="ERROR")&&(this.subscribedTopics.clear(),this.currentSubscribedIndex&&this.attemptWebSocketReconnection())},error:e=>{console.error("WebSocket connection state monitoring error:",e),this.isWebSocketConnected=!1,this.subscribedTopics.clear(),this.currentSubscribedIndex&&this.attemptWebSocketReconnection()}})}};u.\u0275fac=function(t){return new(t||u)(D(K),D(Ne),D(Oe),D(Be),D(He),D(Ee),D(ie))},u.\u0275cmp=j({type:u,selectors:[["app-overall"]],features:[G],decls:6,vars:9,consts:[["dashboardContainer",""],["dashboardContainerComponent",""],[3,"onExportToExcel","onToggleHighlighting","onSetHighlightingPreset","onForceTileRefresh","title","isHighlightingEnabled","isExportingExcel"],[1,"dashboard-container"],[3,"filterValuesChanged","widgets","options","dashboardId"]],template:function(t,i){if(t&1){let a=q();O(0,"vis-dashboard-header",2),E("onExportToExcel",function(){return v(a),V(i.exportDashboardToExcel())})("onToggleHighlighting",function(){return v(a),V(i.toggleHighlightingMode())})("onSetHighlightingPreset",function(n){return v(a),V(i.setHighlightingPreset(n))})("onForceTileRefresh",function(){return v(a),V(i.forceTileRefresh())}),U(),O(1,"p-scrollPanel")(2,"div",3,0)(4,"vis-dashboard-container",4,1),E("filterValuesChanged",function(n){return v(a),V(i.onFilterValuesChanged(n))}),U()()()}t&2&&(L("title",i.dashboardTitle)("isHighlightingEnabled",i.isHighlightingEnabled)("isExportingExcel",i.isExportingExcel),M(),Z(X(8,je)),M(3),L("widgets",i.dashboardConfig.widgets)("options",i.dashboardConfig.config)("dashboardId",i.dashboardConfig.dashboardId))},dependencies:[Q,ee,_e,re,ae,Ae,Me],styles:[".dashboard-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:80vh;padding:.5rem}vis-dashboard-container[_ngcontent-%COMP%]{flex:1 1 auto;min-height:0}.filter-status[_ngcontent-%COMP%]{margin-bottom:1rem;padding:.75rem 1rem;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:8px;border:1px solid #90caf9;box-shadow:0 2px 4px #2196f31a;transition:all .3s ease-in-out}.filter-status[_ngcontent-%COMP%]:hover{box-shadow:0 4px 8px #2196f326;transform:translateY(-1px)}.filter-status-content[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:flex-start}.filter-status-text[_ngcontent-%COMP%]{font-weight:600;color:#1565c0;font-size:.9rem;text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center}.filter-count[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;padding:0 .5rem;background:linear-gradient(135deg,#1976d2,#1565c0);color:#fff;border-radius:12px;font-size:.75rem;font-weight:700;margin-left:.5rem;box-shadow:0 2px 4px #1976d24d}  .filter-status .p-message{background:transparent!important;border:none!important;padding:0!important;margin:0!important}  .filter-status .p-message .p-message-text{color:#1565c0!important;font-weight:600!important;font-size:.9rem!important;text-transform:uppercase!important;letter-spacing:.5px!important}  .filter-status .p-message .p-message-icon{color:#1976d2!important;font-size:1rem!important}[_nghost-%COMP%]{display:block;height:100%;width:100%}  .gridster-item{box-shadow:0 2px 8px #0000001a;border-radius:4px;background-color:#fff;overflow:visible!important;min-height:200px!important;min-width:200px!important;border:2px solid #007bff!important;padding:10px!important;margin:5px!important}  .widget-header{padding:.5rem 1rem;background-color:#f8f9fa;border-bottom:1px solid #e9ecef}  .widget-content{padding:.5rem;height:calc(100% - 40px);min-height:150px}  .echart-container{width:100%!important;height:100%!important;min-height:300px!important;min-width:300px!important;border:4px solid #dc3545!important;background-color:#dc35451a!important;display:flex!important;justify-content:center!important;align-items:center!important;position:relative!important;z-index:10!important;overflow:visible!important}  .echart-widget-container{width:100%!important;height:100%!important;min-height:300px!important;min-width:300px!important;display:flex!important;flex-direction:column!important;justify-content:center!important;align-items:center!important;border:4px solid #ffc107!important;background-color:#ffc1071a!important;padding:10px!important;box-sizing:border-box!important;overflow:visible!important;z-index:5!important;position:relative!important}  .gridster-item{min-height:300px!important;min-width:300px!important;height:auto!important;overflow:visible!important;z-index:1!important}"],changeDetection:0});let h=u;return h})();export{Nt as OverallComponent};
